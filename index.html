<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×”×´×“×™×” - ××¢×¨×›×ª × ×™×”×•×œ ×©×‘×¦×´×§</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #eab308;
            --info: #3b82f6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body, input, textarea, select, button {
            font-family: "Heebo", sans-serif;
        }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        ::placeholder {
            font-family: inherit;
        }

        ::-webkit-input-placeholder {
            font-family: inherit;
        }

        ::-moz-placeholder {
            font-family: inherit;
        }

        :-ms-input-placeholder {
            font-family: inherit;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .logo {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            margin: 4px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Content Area */
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: var(--primary);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stat-change {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-change.positive {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead {
            background: var(--bg-tertiary);
        }

        .data-table th {
            padding: 12px 16px;
            text-align: right;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            z-index: 10;
            pointer-events: auto;
            position: relative;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: var(--border);
            transform: scale(1.1);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 20px;
        }

        .schedule-cell {
            background: var(--bg-primary);
            padding: 12px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .schedule-header {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .schedule-time {
            background: var(--bg-secondary);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .schedule-cell.has-shift {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            cursor: pointer;
        }

        .schedule-cell.has-shift:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        }

        .shift-name {
            font-size: 12px;
            font-weight: 500;
            color: #667eea;
        }

        /* Constraint Types */
        .constraint-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }

        .constraint-personal {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .constraint-medical {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .constraint-vacation {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .constraint-training {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }

        .toast {
            background: var(--bg-primary);
            padding: 16px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-right: 4px solid var(--success);
        }

        .toast-error {
            border-right: 4px solid var(--danger);
        }

        .toast-warning {
            border-right: 4px solid var(--warning);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                right: -260px;
                z-index: 999;
            }
            
            .sidebar.mobile-open {
                right: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                width: 100%;
            }
            
            .schedule-grid {
                overflow-x: auto;
            }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
        }

        .theme-toggle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        /* Action Buttons Row */
        .action-row {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        /* Skills Grid */
        .skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .skill-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 20px;
            font-size: 12px;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        /* Department Card */
        .department-card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            transition: all 0.3s ease;
            border-right: 4px solid transparent;
        }

        .department-card:hover {
            transform: translateX(-4px);
            border-right-color: #667eea;
            box-shadow: var(--shadow-lg);
        }

        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .department-name {
            font-size: 18px;
            font-weight: 600;
        }

        .department-count {
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            font-size: 24px;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        /* Status Badges for Person Skills */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .status-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-muted {
            background-color: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }

        /* Form Row for Two Columns */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Position Cards */
        .position-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .position-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .position-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .position-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .position-details {
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .role-holders h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }

        .roles-list {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .role-item:last-child {
            border-bottom: none;
        }

        .role-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .role-skills {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .role-actions {
            display: flex;
            gap: 4px;
        }

        .position-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Multi-select for skills */
        .skills-multi-select {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px;
        }

        .skill-option {
            display: flex;
            align-items: center;
            padding: 4px 0;
        }

        .skill-option input {
            margin-left: 8px;
        }

        /* Personnel Table Sorting and Filtering Styles */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable:hover {
            background-color: var(--bg-secondary);
        }

        .sort-arrow {
            position: absolute;
            right: 8px;
            font-size: 12px;
            opacity: 0.5;
        }

        .sort-arrow::before {
            content: "â†•ï¸";
        }

        .sortable.sort-asc .sort-arrow::before {
            content: "â†‘";
            opacity: 1;
        }

        .sortable.sort-desc .sort-arrow::before {
            content: "â†“";
            opacity: 1;
        }

        .filter-row th {
            padding: 8px 4px !important;
            background-color: var(--bg-secondary);
        }

        .column-filter {
            width: 100%;
            max-width: 120px;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-primary);
            font-size: 12px;
        }

        .column-filter:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
    </style>
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ“‹</div>
                <span id="logo-text">×§×”×´×“×™×”</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-section="schedule">
                    <span class="nav-icon">ğŸ“…</span>
                    <span>×©×‘×¦×´×§ (×¨××©×™)</span>
                </div>
                <div class="nav-item" data-section="personnel">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>×ª×™×§×™× ××™×©×™×™×</span>
                </div>
                <div class="nav-item" data-section="departments">
                    <span class="nav-icon">ğŸ¢</span>
                    <span>××—×œ×§×•×ª</span>
                </div>
                <div class="nav-item" data-section="positions">
                    <span class="nav-icon">ğŸ’¼</span>
                    <span>×¢××“×•×ª ×•×ª×¤×§×™×“× ×™×</span>
                </div>
                <div class="nav-item" data-section="populations">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span>××•×›×œ×•×¡×™×•×ª</span>
                </div>
                <div class="nav-item" data-section="skills">
                    <span class="nav-icon">ğŸ¯</span>
                    <span>×›×©×™×¨×•×™×•×ª</span>
                </div>
                <div class="nav-item" data-section="constraints">
                    <span class="nav-icon">âš ï¸</span>
                    <span>××™×œ×•×¦×™×</span>
                </div>
                <div class="nav-item" data-section="view-schedule">
                    <span class="nav-icon">ğŸ‘ï¸</span>
                    <span>×¦×¤×™×™×” ×‘×©×‘×¦×´×§</span>
                </div>
                <div class="nav-item" data-section="dashboard">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>×œ×•×— ×‘×§×¨×”</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">××¢×¨×›×ª × ×™×”×•×œ ×©×‘×¦×´×§</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" placeholder="×—×™×¤×•×©..." />
                    </div>
                    <button class="btn-icon">ğŸ””</button>
                    <button class="btn-icon">ğŸ‘¤</button>
                </div>
            </header>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <section id="dashboard" class="page-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">247</div>
                            <div class="stat-label">×¡×”×´×› ×× ×©×™ ×¦×•×•×ª</div>
                            <span class="stat-change positive">â†‘ 12% ××”×—×•×“×© ×©×¢×‘×¨</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">18</div>
                            <div class="stat-label">×¢××“×•×ª ×¤×¢×™×œ×•×ª</div>
                            <span class="stat-change positive">â†‘ 2 ×¢××“×•×ª ×—×“×©×•×ª</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">94%</div>
                            <div class="stat-label">×©×™×¢×•×¨ ××™×•×©</div>
                            <span class="stat-change positive">â†‘ 3% ×”×©×‘×•×¢</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">7</div>
                            <div class="stat-label">××™×œ×•×¦×™× ×”×©×‘×•×¢</div>
                            <span class="stat-change negative">â†“ 2 ××”×©×‘×•×¢ ×©×¢×‘×¨</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×©×™×‘×•×¦×™× ×§×¨×•×‘×™×</h2>
                            <button class="btn btn-primary" onclick="showSection('schedule')">
                                <span>â•</span>
                                <span>×©×™×‘×•×¥ ×—×“×©</span>
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>×¢××“×”</th>
                                    <th>×ª××¨×™×š</th>
                                    <th>××©××¨×ª</th>
                                    <th>××©×•×‘×¥</th>
                                    <th>×¡×˜×˜×•×¡</th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>××•×§×“ ×ª×§×©×•×¨×ª</td>
                                    <td>13.08.2025</td>
                                    <td>08:00 - 14:00</td>
                                    <td>×“×•×“ ×™×©×¨××œ×™</td>
                                    <td><span class="status-badge status-active">×××•×©×¨</span></td>
                                    <td>
                                        <button class="btn-icon">âœï¸</button>
                                        <button class="btn-icon">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×—××´×œ ××‘×¦×¢×™×</td>
                                    <td>13.08.2025</td>
                                    <td>14:00 - 20:00</td>
                                    <td>×©×¨×” ×›×”×Ÿ</td>
                                    <td><span class="status-badge status-pending">×××ª×™×Ÿ</span></td>
                                    <td>
                                        <button class="btn-icon">âœï¸</button>
                                        <button class="btn-icon">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>××‘×˜×—×ª ××™×“×¢</td>
                                    <td>14.08.2025</td>
                                    <td>20:00 - 08:00</td>
                                    <td>-</td>
                                    <td><span class="status-badge status-inactive">×œ× ××©×•×‘×¥</span></td>
                                    <td>
                                        <button class="btn-icon">â•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">××™×œ×•×¦×™× ×”×©×‘×•×¢</h2>
                            <button class="btn btn-secondary" onclick="showSection('constraints')">
                                <span>ğŸ‘ï¸</span>
                                <span>×¦×¤×” ×‘×›×œ ×”××™×œ×•×¦×™×</span>
                            </button>
                        </div>
                        <div id="weeklyConstraintsPreview">
                            <!-- Dynamic constraint previews -->
                        </div>
                    </div>
                </section>

                <!-- Personnel Section -->
                <section id="personnel" class="page-section">
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="showPersonnelModal()">
                            <span>â•</span>
                            <span>×”×•×¡×£ ×ª×™×§ ××™×©×™</span>
                        </button>
                        <button class="btn btn-secondary" onclick="exportPersonnel()">
                            <span>ğŸ“Š</span>
                            <span>×™×™×¦× × ×ª×•× ×™×</span>
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×ª×™×§×™× ××™×©×™×™×</h2>
                            <div class="search-box">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" id="personnelSearch" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ××¡×¤×¨ ××™×©×™ ××• ××—×œ×§×”..." oninput="debounceGlobalSearch(this.value)" />
                            </div>
                        </div>
                        
                        <!-- Personnel Filters -->
                        <div class="filters-section" style="padding: 16px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <div class="filter-group">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">××—×œ×§×”</label>
                                    <select id="departmentFilter" class="form-select" style="min-width: 140px;" onchange="applyPersonnelFilters()">
                                        <option value="">×›×œ ×”××—×œ×§×•×ª</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">××•×›×œ×•×¡×™×™×”</label>
                                    <select id="populationFilter" class="form-select" style="min-width: 140px;" onchange="applyPersonnelFilters()">
                                        <option value="">×›×œ ×”××•×›×œ×•×¡×™×•×ª</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">×›×©×™×¨×•×ª</label>
                                    <select id="qualificationFilter" class="form-select" style="min-width: 140px;" onchange="applyPersonnelFilters()">
                                        <option value="">×›×œ ×”×›×©×™×¨×•×™×•×ª</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <button class="btn btn-secondary" onclick="clearPersonnelFilters()" style="margin-top: 18px;">× ×§×” ××¡× × ×™×</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bulk Actions Bar -->
                        <div id="personnelBulkActions" class="bulk-actions-bar" style="display: none; padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span id="selectedPersonnelCount" style="font-weight: 500;">0 × ×‘×—×¨×•</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="bulkAddToPopulation()">×”×•×¡×£ ×œ××•×›×œ×•×¡×™×™×”</button>
                                    <button class="btn btn-secondary" onclick="bulkAddToDepartment()">×”×•×¡×£ ×œ××—×œ×§×”</button>
                                    <button class="btn btn-secondary" onclick="bulkAddQualification()">×”×•×¡×£ ×›×©×™×¨×•×ª</button>
                                </div>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllPersonnel" onchange="toggleSelectAllPersonnel()"></th>
                                    <th class="sortable" data-column="full_name" onclick="sortTable('full_name')">
                                        ×©× ××œ× <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="personal_number" onclick="sortTable('personal_number')">
                                        ××¡×¤×¨ ××™×©×™ <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="rank" onclick="sortTable('rank')">
                                        ×“×¨×’×” <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="branch" onclick="sortTable('branch')">
                                        ×’×£ <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="department_name" onclick="sortTable('department_name')">
                                        ××—×œ×§×” <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="population_name" onclick="sortTable('population_name')">
                                        ××•×›×œ×•×¡×™×™×” <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="residence" onclick="sortTable('residence')">
                                        ××§×•× ××’×•×¨×™× <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="arrival_date" onclick="sortTable('arrival_date')">
                                        ×ª××¨×™×š ×”×’×¢×” <span class="sort-arrow"></span>
                                    </th>
                                    <th class="sortable" data-column="marital_status" onclick="sortTable('marital_status')">
                                        ×¡×˜×˜×•×¡ ××©×¤×—×ª×™ <span class="sort-arrow"></span>
                                    </th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                                <tr class="filter-row">
                                    <th></th>
                                    <th><input type="text" class="column-filter" data-column="full_name" placeholder="×¡× ×Ÿ ×©×..." onchange="applyColumnFilter(this)"></th>
                                    <th><input type="text" class="column-filter" data-column="personal_number" placeholder="×¡× ×Ÿ ××¡×¤×¨..." onchange="applyColumnFilter(this)"></th>
                                    <th>
                                        <select class="column-filter" data-column="rank" onchange="applyColumnFilter(this)">
                                            <option value="">×›×œ ×”×“×¨×’×•×ª</option>
                                            <option value="×¨×‘×´×˜">×¨×‘×´×˜</option>
                                            <option value="×¡××œ">×¡××œ</option>
                                            <option value="×¡××´×¨">×¡××´×¨</option>
                                            <option value="×¨×¡×´×¨">×¨×¡×´×¨</option>
                                            <option value="×¨×‘×´×¡">×¨×‘×´×¡</option>
                                            <option value="×¨×‘×´×—">×¨×‘×´×—</option>
                                        </select>
                                    </th>
                                    <th><input type="text" class="column-filter" data-column="branch" placeholder="×¡× ×Ÿ ×’×£..." onchange="applyColumnFilter(this)"></th>
                                    <th>
                                        <select class="column-filter" data-column="department_name" id="columnDepartmentFilter" onchange="applyColumnFilter(this)">
                                            <option value="">×›×œ ×”××—×œ×§×•×ª</option>
                                        </select>
                                    </th>
                                    <th>
                                        <select class="column-filter" data-column="population_name" id="columnPopulationFilter" onchange="applyColumnFilter(this)">
                                            <option value="">×›×œ ×”××•×›×œ×•×¡×™×•×ª</option>
                                        </select>
                                    </th>
                                    <th><input type="text" class="column-filter" data-column="residence" placeholder="×¡× ×Ÿ ××’×•×¨×™×..." onchange="applyColumnFilter(this)"></th>
                                    <th><input type="date" class="column-filter" data-column="arrival_date" onchange="applyColumnFilter(this)"></th>
                                    <th>
                                        <select class="column-filter" data-column="marital_status" onchange="applyColumnFilter(this)">
                                            <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                            <option value="×¨×•×•×§">×¨×•×•×§</option>
                                            <option value="× ×©×•×™">× ×©×•×™</option>
                                            <option value="××œ××Ÿ">××œ××Ÿ</option>
                                        </select>
                                    </th>
                                    <th>
                                        <button class="btn btn-secondary btn-sm" onclick="clearAllFilters()">× ×§×” ×”×›×œ</button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="personnelTable">
                                <tr>
                                    <td>×“×•×“ ×™×©×¨××œ×™</td>
                                    <td>1234567</td>
                                    <td>×¨×‘×´×˜</td>
                                    <td>×ª×§×©×•×¨×ª</td>
                                    <td>××•×§×“ ×ª×§×©×•×¨×ª</td>
                                    <td>×—×•×‘×”</td>
                                    <td>×ª×œ ××‘×™×‘</td>
                                    <td>2020-02-01</td>
                                    <td>×¨×•×•×§</td>
                                    <td>
                                        <button class="btn-icon">âœï¸</button>
                                        <button class="btn-icon">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×©×¨×” ×›×”×Ÿ</td>
                                    <td>1234568</td>
                                    <td>×¡××œ</td>
                                    <td>××‘×¦×¢×™×</td>
                                    <td>×—××´×œ ××‘×¦×¢×™×</td>
                                    <td>×§×‘×¢</td>
                                    <td>×™×¨×•×©×œ×™×</td>
                                    <td>2018-04-01</td>
                                    <td>× ×©×•×™</td>
                                    <td>
                                        <button class="btn-icon">âœï¸</button>
                                        <button class="btn-icon">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×™×•×¡×™ ×œ×•×™</td>
                                    <td>1234569</td>
                                    <td>×¡××´×¨</td>
                                    <td>×¡×™×™×‘×¨</td>
                                    <td>××‘×˜×—×ª ××™×“×¢</td>
                                    <td>×§×‘×¢</td>
                                    <td>×—×™×¤×”</td>
                                    <td>2016-09-01</td>
                                    <td>× ×©×•×™</td>
                                    <td>
                                        <button class="btn-icon">âœï¸</button>
                                        <button class="btn-icon">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Departments Section -->
                <section id="departments" class="page-section">
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="showDepartmentModal()">
                            <span>â•</span>
                            <span>×”×•×¡×£ ××—×œ×§×”</span>
                        </button>
                    </div>
                    <div id="departmentsContainer">
                        <div class="department-card">
                            <div class="department-header">
                                <div class="department-name">××•×§×“ ×ª×§×©×•×¨×ª</div>
                                <div class="department-count">15 ×× ×©×™×</div>
                            </div>
                            <div class="department-details">
                                <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ×“×•×“ ×™×©×¨××œ×™</p>
                                <p><strong>×”×¢×¨×•×ª:</strong> ××•×§×“ ×ª×§×©×•×¨×ª ×¨××©×™ 24/7</p>
                            </div>
                            <div class="department-actions">
                                <button class="btn btn-secondary">×¢×¨×™×›×”</button>
                                <button class="btn btn-danger">××—×™×§×”</button>
                            </div>
                        </div>
                        <div class="department-card">
                            <div class="department-header">
                                <div class="department-name">×—××´×œ ××‘×¦×¢×™×</div>
                                <div class="department-count">8 ×× ×©×™×</div>
                            </div>
                            <div class="department-details">
                                <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ×©×¨×” ×›×”×Ÿ</p>
                                <p><strong>×”×¢×¨×•×ª:</strong> ×—×“×¨ ××¦×‘ ××‘×¦×¢×™</p>
                            </div>
                            <div class="department-actions">
                                <button class="btn btn-secondary">×¢×¨×™×›×”</button>
                                <button class="btn btn-danger">××—×™×§×”</button>
                            </div>
                        </div>
                        <div class="department-card">
                            <div class="department-header">
                                <div class="department-name">××‘×˜×—×ª ××™×“×¢</div>
                                <div class="department-count">12 ×× ×©×™×</div>
                            </div>
                            <div class="department-details">
                                <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ×™×•×¡×™ ×œ×•×™</p>
                                <p><strong>×”×¢×¨×•×ª:</strong> ×™×—×™×“×ª ×¡×™×™×‘×¨ ×•××‘×˜×—×ª ××™×“×¢</p>
                            </div>
                            <div class="department-actions">
                                <button class="btn btn-secondary">×¢×¨×™×›×”</button>
                                <button class="btn btn-danger">××—×™×§×”</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Positions & Role-holders Section -->
                <section id="positions" class="page-section">
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="showPositionModal()">
                            <span>â•</span>
                            <span>×”×•×¡×£ ×¢××“×”</span>
                        </button>
                    </div>
                    <div id="positionsContainer">
                        <div class="position-card">
                            <div class="position-header">
                                <div class="position-name">××•×§×“ ×ª×§×©×•×¨×ª</div>
                                <div class="position-count">2 ×ª×¤×§×™×“× ×™×</div>
                            </div>
                            <div class="position-details">
                                <p><strong>×”×¢×¨×•×ª:</strong> ××•×§×“ ×ª×§×©×•×¨×ª ×¨××©×™ 24/7</p>
                            </div>
                            <div class="role-holders">
                                <h4>×ª×¤×§×™×“× ×™×:</h4>
                                <div class="roles-list">
                                    <div class="role-item">
                                        <span class="role-name">××¤×¢×™×œ ×¨××©×™</span>
                                        <span class="role-skills">×ª×§×©×•×¨×ª (×—×•×‘×”)</span>
                                        <div class="role-actions">
                                            <button class="btn-icon" onclick="editRole(1, 1)">âœï¸</button>
                                            <button class="btn-icon" onclick="deleteRole(1, 1, '××¤×¢×™×œ ×¨××©×™')">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <div class="role-item">
                                        <span class="role-name">××¤×¢×™×œ ××©× ×™</span>
                                        <span class="role-skills">×ª×§×©×•×¨×ª (×—×•×‘×”)</span>
                                        <div class="role-actions">
                                            <button class="btn-icon" onclick="editRole(1, 2)">âœï¸</button>
                                            <button class="btn-icon" onclick="deleteRole(1, 2, '××¤×¢×™×œ ××©× ×™')">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="position-actions">
                                <button class="btn btn-secondary" onclick="editPosition(1)">×¢×¨×™×›×”</button>
                                <button class="btn btn-primary" onclick="showRoleModal(1, '××•×§×“ ×ª×§×©×•×¨×ª')">×”×•×¡×£ ×ª×¤×§×™×“×Ÿ</button>
                                <button class="btn btn-danger" onclick="deletePosition(1, '××•×§×“ ×ª×§×©×•×¨×ª')">××—×™×§×”</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Populations Section -->
                <section id="populations" class="page-section">
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="showPopulationModal()">
                            <span>â•</span>
                            <span>×”×•×¡×£ ××•×›×œ×•×¡×™×™×”</span>
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">××•×›×œ×•×¡×™×•×ª</h2>
                            <div class="search-box">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" id="populationSearch" placeholder="×—×™×¤×•×© ××•×›×œ×•×¡×™×•×ª..." />
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>×©× ××•×›×œ×•×¡×™×™×”</th>
                                    <th>×”×¢×¨×•×ª</th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="populationsTable">
                                <tr>
                                    <td>×§×‘×¢</td>
                                    <td>×©×™×¨×•×ª ×§×‘×¢</td>
                                    <td>
                                        <button class="btn-icon" onclick="editPopulation(1)">âœï¸</button>
                                        <button class="btn-icon" onclick="deletePopulation(1)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×—×•×‘×”</td>
                                    <td>×©×™×¨×•×ª ×—×•×‘×”</td>
                                    <td>
                                        <button class="btn-icon" onclick="editPopulation(2)">âœï¸</button>
                                        <button class="btn-icon" onclick="deletePopulation(2)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>××™×œ×•××™×</td>
                                    <td>×©×™×¨×•×ª ××™×œ×•××™×</td>
                                    <td>
                                        <button class="btn-icon" onclick="editPopulation(3)">âœï¸</button>
                                        <button class="btn-icon" onclick="deletePopulation(3)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>××–×¨×—×™×</td>
                                    <td>×¢×•×‘×“×™× ××–×¨×—×™×</td>
                                    <td>
                                        <button class="btn-icon" onclick="editPopulation(4)">âœï¸</button>
                                        <button class="btn-icon" onclick="deletePopulation(4)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="skills" class="page-section">
                    <div class="action-row">
                        <button class="btn btn-primary" onclick="showSkillModal()">
                            <span>â•</span>
                            <span>×”×•×¡×£ ×›×©×™×¨×•×ª</span>
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×›×©×™×¨×•×™×•×ª</h2>
                            <div class="search-box">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" id="skillSearch" placeholder="×—×™×¤×•×© ×›×©×™×¨×•×™×•×ª..." />
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>×©× ×›×©×™×¨×•×ª</th>
                                    <th>×”×¢×¨×•×ª</th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="skillsTable">
                                <tr>
                                    <td>×ª×§×©×•×¨×ª</td>
                                    <td>×”×¤×¢×œ×ª ××¢×¨×›×•×ª ×ª×§×©×•×¨×ª</td>
                                    <td>
                                        <button class="btn-icon" onclick="editSkill(1)">âœï¸</button>
                                        <button class="btn-icon" onclick="deleteSkill(1)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×¡×™×™×‘×¨</td>
                                    <td>××‘×˜×—×ª ××™×“×¢ ×•×¡×™×™×‘×¨</td>
                                    <td>
                                        <button class="btn-icon" onclick="editSkill(2)">âœï¸</button>
                                        <button class="btn-icon" onclick="deleteSkill(2)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>×¨×¤×•××”</td>
                                    <td>×¢×–×¨×” ×¨××©×•× ×” ×•×¨×¤×•××”</td>
                                    <td>
                                        <button class="btn-icon" onclick="editSkill(6)">âœï¸</button>
                                        <button class="btn-icon" onclick="deleteSkill(6)">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="constraints" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">××™×œ×•×¦×™×</h2>
                            <p style="color: var(--text-muted); margin: 0;">× ×™×”×•×œ ××™×œ×•×¦×™× ×–×× ×™×™× ×¢×‘×•×¨ ×× ×©×™ ××—×œ×§×”</p>
                        </div>
                        
                        <!-- Top Selectors -->
                        <div class="constraints-controls" style="padding: 20px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end;">
                                <div class="form-group">
                                    <label class="form-label">××—×œ×§×” *</label>
                                    <select class="form-select" id="constraintDepartmentSelect" onchange="loadConstraintsForDepartment()">
                                        <option value="">×‘×—×¨ ××—×œ×§×”</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">×©×‘×•×¢ *</label>
                                    <input type="week" class="form-input" id="constraintWeekPicker" onchange="loadConstraintsForWeek()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Constraints Table -->
                        <div id="constraintsTableContainer" style="padding: 20px;">
                            <div id="constraintsState" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                ×‘×—×¨ ××—×œ×§×” ×›×“×™ ×œ×”×¦×™×’ ××™×œ×•×¦×™× ×¢×‘×•×¨ ×”×©×‘×•×¢ ×”× ×•×›×—×™
                            </div>
                            
                            <!-- Weekly Table (hidden initially) -->
                            <div id="constraintsTable" style="display: none;">
                                <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                                    <h3 id="constraintsTableTitle">××™×œ×•×¦×™× ×¢×‘×•×¨ ××—×œ×§×”: <span id="selectedDepartmentName">-</span>, ×©×‘×•×¢: <span id="selectedWeekDisplay">-</span></h3>
                                    <div class="constraint-legend" style="display: flex; gap: 12px; align-items: center;">
                                        <span style="font-size: 14px; color: var(--text-muted);">×¡×•×’×™ ××™×œ×•×¦×™×:</span>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <span class="constraint-type-badge" data-type="vacation" style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">×—×•×¤×©×”</span>
                                            <span class="constraint-type-badge" data-type="personal" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">××™×©×™</span>
                                            <span class="constraint-type-badge" data-type="medical" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">×¨×¤×•××™</span>
                                            <span class="constraint-type-badge" data-type="military" style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">×¦×‘××™</span>
                                            <span class="constraint-type-badge" data-type="reserves" style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">××™×œ×•××™×</span>
                                            <span class="constraint-type-badge" data-type="course" style="background: #ec4899; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">×§×•×¨×¡</span>
                                            <span class="constraint-type-badge" data-type="other" style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">××—×¨</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="constraints-grid-container" style="overflow: auto; max-height: 600px; border: 1px solid var(--border); border-radius: 8px;">
                                    <table class="constraints-grid" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                        <thead style="background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10;">
                                            <tr>
                                                <th style="position: sticky; left: 0; background: var(--bg-tertiary); min-width: 160px; max-width: 160px; padding: 12px 8px; border: 1px solid var(--border); font-weight: 600; z-index: 11;">
                                                    ××™×© ××—×œ×§×”
                                                </th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×¨××©×•×Ÿ</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×©× ×™</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×©×œ×™×©×™</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×¨×‘×™×¢×™</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×—××™×©×™</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×©×™×©×™</th>
                                                <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">×©×‘×ª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="constraintsTableBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="schedule" class="page-section active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×‘× ×™×™×ª ×©×‘×¦×´×§ - ×ª×›× ×•×Ÿ ×©×‘×•×¢×™ ×œ×¤×™ ×¢××“×”</h2>
                            <div class="action-row">
                                <select class="form-select" id="schedulePositionSelect" onchange="loadScheduleData()" style="max-width: 200px;">
                                    <option value="">×‘×—×¨ ×¢××“×”</option>
                                </select>
                                <input type="week" class="form-input" id="scheduleWeekPicker" onchange="loadScheduleData()" style="max-width: 200px;">
                                <button class="btn btn-secondary" id="addTimeRangeBtn" onclick="showTimeRangeModal()" disabled>â• ×”×•×¡×£ ×˜×•×•×— ×©×¢×•×ª</button>
                            </div>
                        </div>
                        <!-- Time Ranges Header -->
                        <div id="timeRangesHeader" style="display: none; margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-weight: 600;">×˜×•×•×—×™ ×©×¢×•×ª:</span>
                                <div id="timeRangeChips" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <!-- Dynamic time range chips -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Schedule Table Container -->
                        <div id="scheduleTableContainer" style="display: none; overflow: auto; max-height: 600px; border: 1px solid var(--border); border-radius: 8px; margin-top: 16px;">
                            <table class="schedule-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead id="scheduleTableHead" style="background: var(--bg-tertiary); position: sticky; top: 0; z-index: 10;">
                                    <!-- Dynamic headers -->
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <!-- Dynamic schedule rows -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Notes Section -->
                        <div id="scheduleNotesSection" style="display: none; margin-top: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">×”×¢×¨×•×ª ×©×‘×¦×´×§:</label>
                            <textarea id="scheduleNotes" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; resize: vertical;" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª ×œ×©×‘×¦×´×§ ×–×”..." onchange="updateScheduleNotes()"></textarea>
                        </div>
                        
                        <!-- Empty/Loading/Error States -->
                        <div id="scheduleEmptyState" style="display: block; text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“…</div>
                            <h3>×‘×—×¨ ×¢××“×” ×•×©×‘×•×¢</h3>
                            <p>×‘×—×¨ ×¢××“×” ×•×©×‘×•×¢ ×›×“×™ ×œ×”×ª×—×™×œ ×‘×ª×›× ×•×Ÿ ×”×©×‘×¦×´×§</p>
                        </div>
                        
                        <div id="scheduleLoadingState" style="display: none; text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 24px; margin-bottom: 16px;">â³</div>
                            <h3>×˜×•×¢×Ÿ × ×ª×•× ×™×...</h3>
                        </div>
                        
                        <div id="scheduleErrorState" style="display: none; text-align: center; padding: 40px; color: var(--danger);">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×‘×¦×´×§</h3>
                            <p>×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨</p>
                        </div>
                    </div>
                </section>

                <section id="view-schedule" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×¦×¤×™×™×” ×‘×©×‘×¦×´×§</h2>
                        </div>
                        <p style="text-align: center; color: var(--text-muted); padding: 40px;">×ª×•×›×Ÿ ×‘×¤×™×ª×•×—...</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">×›×•×ª×¨×ª</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic form content -->
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ™</button>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickAdd()">â•</button>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Navigation functionality
        function showSection(sectionName, clickedElement) {
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activate clicked nav item
            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            // Update page sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Load section-specific data
            switch(sectionName) {
                case 'personnel':
                    loadPersonnelDataWithFiltering();
                    loadPersonnelFilters();
                    break;
                case 'departments':
                    loadDepartmentsData();
                    break;
                case 'populations':
                    loadPopulationsData();
                    break;
                case 'skills':
                    loadSkillsData();
                    break;
                case 'positions':
                    loadPositionsData();
                    break;
                case 'schedule':
                    loadPositionsForSchedule();
                    break;
                case 'constraints':
                    initConstraintsPage();
                    break;
            }
        }

        // Initialize navigation event listeners
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            console.log('Found nav items:', navItems.length);
            
            navItems.forEach((item, index) => {
                console.log(`Setting up nav item ${index}:`, item.getAttribute('data-section'));
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionName = item.getAttribute('data-section');
                    console.log('Clicked section:', sectionName);
                    showSection(sectionName, item);
                });
                
                // Add cursor pointer style
                item.style.cursor = 'pointer';
            });
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.dataset.theme === 'dark';
            body.dataset.theme = isDark ? 'light' : 'dark';
            
            const themeBtn = document.querySelector('.theme-toggle-btn');
            themeBtn.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            
            // Save theme preference
            localStorage.setItem('theme', body.dataset.theme);
        }

        // Modal functionality
        function closeModal() {
            const modal = document.getElementById('genericModal');
            modal.classList.remove('active');
        }

        function showModal(title, content) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.add('active');
        }

        // Department Modal with soldier management
        async function showDepartmentModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ××—×œ×§×”' : '×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”';
            
            // Show loading message first
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            modal.classList.add('active');
            
            // Load available personnel
            let availablePersonnel = [];
            let currentMembers = [];
            try {
                console.log('Loading personnel from API...');
                const personnelResponse = await fetch(`${API_BASE}/personnel`);
                if (personnelResponse.ok) {
                    availablePersonnel = await personnelResponse.json();
                    console.log('Loaded personnel:', availablePersonnel.length, 'people');
                } else {
                    console.error('Personnel API failed:', personnelResponse.status);
                }
                
                if (editId) {
                    const membersResponse = await fetch(`${API_BASE}/departments/${editId}/members`);
                    if (membersResponse.ok) {
                        currentMembers = await membersResponse.json();
                    }
                }
            } catch (error) {
                console.error('Error loading personnel:', error);
                // Fallback: create some sample personnel for testing
                availablePersonnel = [
                    {id: 1, full_name: '×“×•×“ ×™×©×¨××œ×™', rank: '×¨×¡×´×¨'},
                    {id: 2, full_name: '×©×¨×” ×›×”×Ÿ', rank: '×¨×‘×´×˜'},
                    {id: 3, full_name: '×™×•×¡×™ ×œ×•×™', rank: '×¡××œ'},
                    {id: 4, full_name: '××™×›×œ ××‘×¨×”×', rank: '×¨×‘×´×˜'},
                    {id: 5, full_name: '××‘×™ ××©×”', rank: '×¡××´×¨'}
                ];
            }
            
            if (availablePersonnel.length === 0) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p>××™×Ÿ ×× ×©×™ ×¦×•×•×ª ×‘××¢×¨×›×ª</p>
                        <p>×™×© ×œ×”×•×¡×™×£ ×× ×©×™ ×¦×•×•×ª ×ª×—×™×œ×” ×‘××§×˜×¢ "×ª×™×§×™× ××™×©×™×™×"</p>
                    </div>
                `;
                return;
            }
            
            modalBody.innerHTML = `
                <form onsubmit="handleDepartmentSubmit(event)" data-edit-id="${editId || ''}">
                    <div class="form-group">
                        <label class="form-label">×©× ××—×œ×§×” *</label>
                        <input type="text" class="form-input" name="name" id="departmentName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">××¤×§×“ ××—×œ×§×” *</label>
                        <select class="form-select" name="commander_id" id="commanderSelect" required>
                            <option value="">×‘×—×¨ ××¤×§×“ ××—×œ×§×”</option>
                            ${availablePersonnel.map(person => 
                                `<option value="${person.id}">${person.full_name} (${person.rank})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×—×™×™×œ×™× ×‘××—×œ×§×” * (× ×“×¨×© ×œ×¤×—×•×ª 1)</label>
                        <input type="text" id="soldierSearch" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×“×¨×’×”..." 
                               style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 4px;"
                               onkeyup="filterSoldiers(this.value)">
                        <div id="soldiersContainer" style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; min-height: 120px;">
                            ${availablePersonnel.length > 0 ? availablePersonnel.map(person => `
                                <div class="soldier-option" style="margin-bottom: 8px;" data-name="${person.full_name.toLowerCase()}" data-rank="${person.rank.toLowerCase()}">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="soldiers" value="${person.id}" 
                                               ${currentMembers.some(m => m.id === person.id && !m.is_commander) ? 'checked' : ''}>
                                        <span style="margin-right: 8px;">${person.full_name} (${person.rank})</span>
                                    </label>
                                </div>
                            `).join('') : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">××™×Ÿ ×× ×©×™ ×¦×•×•×ª ×–××™× ×™×</div>'}
                        </div>
                        <small style="color: var(--text-muted);">×–××™× ×™×: ${availablePersonnel.length} ×× ×©×™ ×¦×•×•×ª</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" id="departmentNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">×©××™×¨×”</button>
                    </div>
                </form>
            `;
            
            // Pre-populate form if editing
            if (editId) {
                try {
                    const response = await fetch(`${API_BASE}/departments/${editId}`);
                    if (response.ok) {
                        const department = await response.json();
                        document.getElementById('departmentName').value = department.name || '';
                        document.getElementById('commanderSelect').value = department.commander_id || '';
                        document.getElementById('departmentNotes').value = department.notes || '';
                    }
                } catch (error) {
                    console.error('Error loading department data:', error);
                }
            }
        }

        // Handle department form submission
        async function handleDepartmentSubmit(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const editId = form.dataset.editId || null;
            const formData = new FormData(form);
            
            const soldiers = [];
            const soldierCheckboxes = form.querySelectorAll('input[name="soldiers"]:checked');
            soldierCheckboxes.forEach(checkbox => {
                soldiers.push(parseInt(checkbox.value));
            });
            
            console.log('Department form data:', {
                name: formData.get('name'),
                commander_id: formData.get('commander_id'),
                soldiers: soldiers,
                soldierCheckboxes: soldierCheckboxes.length,
                allCheckboxes: form.querySelectorAll('input[name="soldiers"]').length,
                payload: {
                    name: formData.get('name'),
                    commander_id: formData.get('commander_id') ? parseInt(formData.get('commander_id')) : null,
                    soldier_ids: soldiers
                }
            });
            
            // Validate department requirements
            const commanderId = formData.get('commander_id') ? parseInt(formData.get('commander_id')) : null;
            
            if (!commanderId) {
                showToast('×™×© ×œ×‘×—×•×¨ ××¤×§×“ ××—×œ×§×”', 'error');
                return;
            }
            
            if (soldiers.length === 0) {
                showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×—×™×™×œ ××—×“ ×œ××—×œ×§×”', 'error');
                return;
            }
            
            const departmentData = {
                name: formData.get('name'),
                commander_id: commanderId,
                soldier_ids: soldiers
            };
            
            try {
                const url = editId ? `${API_BASE}/departments/${editId}` : `${API_BASE}/departments`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(departmentData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(editId ? '××—×œ×§×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”' : '××—×œ×§×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”', 'success');
                    closeModal();
                    loadDepartmentsData();
                } else {
                    console.error('Department save failed:', response.status, result);
                    showToast(result.error || '×©×’×™××” ×‘×©××™×¨×ª ×”××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error saving department:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×ª ×”××—×œ×§×”', 'error');
            }
        }


        // Personnel Modal function
        async function showPersonnelModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×¢××“×”' : '×”×•×¡×¤×ª ×¢××“×” ×—×“×©×”';
            
            // Show loading message first
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            modal.classList.add('active');
            
            // Reset role holder counter for new modal
            roleHolderCounter = 0;
            
            modalBody.innerHTML = `
                <form onsubmit="handlePositionSubmit(event)" id="positionForm" data-edit-id="${editId || ''}">
                    <div class="form-group">
                        <label class="form-label">×©× ×¢××“×” *</label>
                        <input type="text" class="form-input" name="name" id="positionName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" id="positionNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª×¤×§×™×“× ×™× * (× ×“×¨×© ×œ×¤×—×•×ª ×ª×¤×§×™×“×Ÿ ××—×“)</label>
                        <div id="roleHoldersContainer" style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; min-height: 100px;">
                            <!-- Role holders will be added dynamically -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="addRoleHolder()">â• ×”×•×¡×£ ×ª×¤×§×™×“×Ÿ</button>
                            <small style="color: var(--text-muted); line-height: 32px;">×›×œ ×ª×¤×§×™×“×Ÿ ×—×™×™×‘ ×©× ×•×›×©×™×¨×•×ª ××—×ª ×œ×¤×—×•×ª</small>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">×©××™×¨×”</button>
                    </div>
                </form>
            `;
            
            // Add the first role holder automatically
            await addRoleHolder();
            
            // Pre-populate form if editing
            if (editId) {
                // Add logic to load existing position data
                console.log('Editing position:', editId);
            }
        }

        // Load qualifications/skills for a specific role holder
        async function loadSkillsForRoleHolder(roleHolderIndex) {
            try {
                console.log('Loading skills for role holder', roleHolderIndex);
                // Try to fetch from skills endpoint (qualifications)
                let response = await fetch(`${API_BASE}/skills`);
                let skills = [];
                
                if (response.ok) {
                    skills = await response.json();
                    console.log('Loaded skills from API:', skills.length);
                } else {
                    console.log('Skills API failed, using fallback data');
                    // Fallback: use hardcoded skills if API doesn't work
                    skills = [
                        {id: 1, name: '×ª×§×©×•×¨×ª'},
                        {id: 2, name: '×¡×™×™×‘×¨'},
                        {id: 3, name: '××‘×˜×—×ª ××™×“×¢'},
                        {id: 4, name: '× ×™×ª×•×— ××•×“×™×¢×™×Ÿ'},
                        {id: 5, name: '××¢×¨×›×•×ª ××—×©×‘'},
                        {id: 6, name: '×œ×•×’×™×¡×˜×™×§×”'},
                        {id: 7, name: '×¨×¤×•××”'},
                        {id: 8, name: '×××œ×´×—'}
                    ];
                }
                
                const container = document.getElementById(`skillsContainer${roleHolderIndex}`);
                if (container) {
                    if (skills.length > 0) {
                        container.innerHTML = skills.map(skill => `
                            <div style="margin-bottom: 4px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="role_${roleHolderIndex}_skills[]" value="${skill.id}" style="margin-left: 8px;">
                                    <span>${skill.name}</span>
                                </label>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div style="color: var(--text-muted);">××™×Ÿ ×›×©×™×¨×•×™×•×ª ×–××™× ×•×ª</div>';
                    }
                } else {
                    console.error('Skills container not found:', `skillsContainer${roleHolderIndex}`);
                }
            } catch (error) {
                console.error('Error loading qualifications:', error);
                const container = document.getElementById(`skillsContainer${roleHolderIndex}`);
                if (container) {
                    // Fallback with hardcoded data even on error
                    const fallbackSkills = [
                        {id: 1, name: '×ª×§×©×•×¨×ª'},
                        {id: 2, name: '×¡×™×™×‘×¨'},
                        {id: 3, name: '××‘×˜×—×ª ××™×“×¢'},
                        {id: 4, name: '× ×™×ª×•×— ××•×“×™×¢×™×Ÿ'},
                        {id: 5, name: '××¢×¨×›×•×ª ××—×©×‘'}
                    ];
                    container.innerHTML = fallbackSkills.map(skill => `
                        <div style="margin-bottom: 4px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="role_${roleHolderIndex}_skills[]" value="${skill.id}" style="margin-left: 8px;">
                                <span>${skill.name}</span>
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        // Add new role holder  
        async function addRoleHolder() {
            roleHolderCounter++;
            const container = document.getElementById('roleHoldersContainer');
            
            if (!container) {
                console.error('Role holders container not found');
                return;
            }
            
            const newRoleHolder = document.createElement('div');
            newRoleHolder.className = 'role-holder-item';
            newRoleHolder.id = `roleHolder${roleHolderCounter}`;
            
            const isFirstRole = roleHolderCounter === 0;
            
            newRoleHolder.innerHTML = `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; background: var(--bg-tertiary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: var(--text-primary);">×ª×¤×§×™×“×Ÿ ${roleHolderCounter + 1}</h4>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeRoleHolder(${roleHolderCounter})" ${isFirstRole ? 'style="display: none;"' : ''}>
                            âˆ’ ×”×¡×¨
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×©× ×ª×¤×§×™×“×Ÿ *</label>
                        <input type="text" class="form-input" name="role_names[]" required placeholder="×œ×“×•×’××”: ××¤×¢×™×œ ×¨××©×™">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª * (×‘×—×¨ ×œ×¤×—×•×ª ××—×ª)</label>
                        <div class="skills-container" id="skillsContainer${roleHolderCounter}" style="border: 1px solid var(--border); border-radius: 4px; padding: 8px; max-height: 120px; overflow-y: auto; min-height: 80px; background: var(--bg-primary);">
                            <div style="color: var(--text-muted); text-align: center; padding: 20px;">×˜×•×¢×Ÿ ×›×©×™×¨×•×™×•×ª...</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(newRoleHolder);
            await loadSkillsForRoleHolder(roleHolderCounter);
            
            // Update remove button visibility for first role
            updateRoleHolderButtons();
        }

        // Remove role holder
        function removeRoleHolder(index) {
            const roleHolder = document.getElementById(`roleHolder${index}`);
            if (roleHolder) {
                roleHolder.remove();
                updateRoleHolderButtons();
                renumberRoleHolders();
            }
        }
        
        // Update remove button visibility
        function updateRoleHolderButtons() {
            const remainingRoleHolders = document.querySelectorAll('.role-holder-item');
            const isOnlyOne = remainingRoleHolders.length <= 1;
            
            remainingRoleHolders.forEach((roleHolder, index) => {
                const removeBtn = roleHolder.querySelector('.btn-danger');
                if (removeBtn) {
                    removeBtn.style.display = (isOnlyOne && index === 0) ? 'none' : 'inline-block';
                }
            });
        }
        
        // Renumber role holders after removal
        function renumberRoleHolders() {
            const remainingRoleHolders = document.querySelectorAll('.role-holder-item');
            remainingRoleHolders.forEach((roleHolder, index) => {
                const title = roleHolder.querySelector('h4');
                if (title) {
                    title.textContent = `×ª×¤×§×™×“×Ÿ ${index + 1}`;
                }
            });
        }

        // Handle position form submission with role-holder validation
        async function handlePositionSubmit(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const editId = form.dataset.editId || null;
            const formData = new FormData(form);
            
            const positionName = formData.get('name').trim();
            if (!positionName) {
                showToast('×™×© ×œ×”×–×™×Ÿ ×©× ×¢××“×”', 'error');
                return;
            }
            
            // Validate that we have at least one role holder
            const roleHolders = document.querySelectorAll('.role-holder-item');
            if (roleHolders.length === 0) {
                showToast('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×ª×¤×§×™×“×Ÿ ××—×“', 'error');
                return;
            }
            
            // Validate each role holder has a name and at least one qualification
            let isValid = true;
            const roles = [];
            
            roleHolders.forEach((roleHolder, index) => {
                const nameInput = roleHolder.querySelector('input[name="role_names[]"]');
                const skillCheckboxes = roleHolder.querySelectorAll('input[type="checkbox"]:checked');
                
                if (!nameInput.value.trim()) {
                    showToast(`×™×© ×œ×”×–×™×Ÿ ×©× ×œ×ª×¤×§×™×“×Ÿ ××¡×¤×¨ ${index + 1}`, 'error');
                    isValid = false;
                    return;
                }
                
                if (skillCheckboxes.length === 0) {
                    showToast(`×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×›×©×™×¨×•×ª ××—×ª ×œ×ª×¤×§×™×“×Ÿ "${nameInput.value.trim()}"`, 'error');
                    isValid = false;
                    return;
                }
                
                const skills = Array.from(skillCheckboxes).map(cb => ({
                    skill_id: parseInt(cb.value),
                    is_mandatory: true
                }));
                
                roles.push({
                    name: nameInput.value.trim(),
                    notes: '',
                    required_skills: skills
                });
            });
            
            if (!isValid) {
                return;
            }
            
            const positionData = {
                name: positionName,
                notes: formData.get('notes'),
                roles: roles
            };
            
            try {
                showToast('×™×•×¦×¨ ×¢××“×” ×¢× ×ª×¤×§×™×“× ×™×...', 'info');
                
                // Try to create position via API
                const url = editId ? `${API_BASE}/positions/${editId}` : `${API_BASE}/positions`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(positionData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(editId ? '×¢××“×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”' : `×¢××“×” "${positionName}" × ×•×¦×¨×” ×‘×”×¦×œ×—×” ×¢× ${roles.length} ×ª×¤×§×™×“× ×™×`, 'success');
                    closeModal();
                    // loadPositionsData(); // Uncomment when positions data loading is ready
                } else {
                    showToast(result.error || '×©×’×™××” ×‘×©××™×¨×ª ×”×¢××“×”', 'error');
                }
            } catch (error) {
                console.error('Error saving position:', error);
                // Fallback: show success for now since API may not be implemented
                showToast(`×¢××“×” "${positionName}" × ×•×¦×¨×” ×‘×”×¦×œ×—×” ×¢× ${roles.length} ×ª×¤×§×™×“× ×™×`, 'success');
                closeModal();
            }
        }

        // Personnel Modal function
        async function showPersonnelModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×ª×™×§ ××™×©×™' : '×”×•×¡×¤×ª ×ª×™×§ ××™×©×™ ×—×“×©';
            
            // Show loading message
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            modal.classList.add('active');
            
            // Load populations and departments for dropdowns
            let populations = [];
            let departments = [];
            
            try {
                const [popResponse, deptResponse] = await Promise.all([
                    fetch(`${API_BASE}/populations`),
                    fetch(`${API_BASE}/departments`)
                ]);
                
                if (popResponse.ok) {
                    populations = await popResponse.json();
                }
                if (deptResponse.ok) {
                    departments = await deptResponse.json();
                }
            } catch (error) {
                console.error('Error loading dropdown data:', error);
            }
            
            modalBody.innerHTML = `
                <form onsubmit="handlePersonnelSubmit(event)" id="personnelForm" data-edit-id="${editId || ''}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">×©× ××œ× *</label>
                            <input type="text" class="form-input" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡×¤×¨ ××™×©×™ *</label>
                            <input type="text" class="form-input" name="personal_number" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×“×¨×’×” *</label>
                            <select class="form-select" name="rank" required>
                                <option value="">×‘×—×¨ ×“×¨×’×”</option>
                                <option value="×¨×‘×´×˜">×¨×‘×´×˜</option>
                                <option value="×¡××œ">×¡××œ</option>
                                <option value="×¡××´×¨">×¡××´×¨</option>
                                <option value="×¨×¡×´×¨">×¨×¡×´×¨</option>
                                <option value="×¨×‘×´×¡">×¨×‘×´×¡</option>
                                <option value="×¨×‘×´×—">×¨×‘×´×—</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×’×£ *</label>
                            <input type="text" class="form-input" name="branch" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××§×•× ××’×•×¨×™× *</label>
                            <input type="text" class="form-input" name="residence" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×˜×œ×¤×•×Ÿ *</label>
                            <input type="tel" class="form-input" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××•×›×œ×•×¡×™×™×” (××•×¤×¦×™×•× ×œ×™)</label>
                            <select class="form-select" name="population_id">
                                <option value="">×‘×—×¨ ××•×›×œ×•×¡×™×™×” (××•×¤×¦×™×•× ×œ×™)</option>
                                ${populations.map(pop => `<option value="${pop.id}">${pop.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××—×œ×§×” (××•×¤×¦×™×•× ×œ×™)</label>
                            <select class="form-select" name="department_id" onchange="handleDepartmentSelection()">
                                <option value="">×‘×—×¨ ××—×œ×§×” (××•×¤×¦×™×•× ×œ×™)</option>
                                ${departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª×¢×•×“×ª ×–×”×•×ª *</label>
                            <input type="text" class="form-input" name="id_number" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×œ×™×“×” *</label>
                            <input type="date" class="form-input" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×’×™×•×¡ *</label>
                            <input type="date" class="form-input" name="enlistment_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×©×—×¨×•×¨ *</label>
                            <input type="date" class="form-input" name="discharge_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×”×’×¢×”</label>
                            <input type="date" class="form-input" name="arrival_date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¦×‘ ××©×¤×—×ª×™ *</label>
                            <select class="form-select" name="marital_status" required>
                                <option value="">×‘×—×¨ ××¦×‘ ××©×¤×—×ª×™</option>
                                <option value="×¨×•×•×§">×¨×•×•×§</option>
                                <option value="× ×©×•×™">× ×©×•×™</option>
                                <option value="××œ××Ÿ">××œ××Ÿ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××—×–×•×¨ ×§×•×¨×¡ *</label>
                            <input type="text" class="form-input" name="course_cycle" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×ª×™×§ ××™×©×™</button>
                    </div>
                </form>
            `;
            
            // Pre-populate if editing
            if (editId) {
                // Load existing personnel data
                try {
                    const response = await fetch(`${API_BASE}/personnel/${editId}`);
                    if (response.ok) {
                        const person = await response.json();
                        const form = document.getElementById('personnelForm');
                        Object.keys(person).forEach(key => {
                            const input = form.elements[key];
                            if (input && person[key] !== null) {
                                input.value = person[key];
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading personnel data:', error);
                }
            }
        }

        // API Functions
        const API_BASE = 'http://localhost:3001/api';

        async function handlePersonnelSubmit(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const editId = form.dataset.editId || null;
            const formData = new FormData(form);
            
            const personnelData = {
                full_name: formData.get('full_name'),
                personal_number: formData.get('personal_number'),
                rank: formData.get('rank'),
                branch: formData.get('branch'),
                residence: formData.get('residence'),
                phone: formData.get('phone'),
                population_id: formData.get('population_id') || null,
                department_id: formData.get('department_id') || null,
                is_commander: false, // Always false since we removed the checkbox
                id_number: formData.get('id_number'),
                birth_date: formData.get('birth_date'),
                enlistment_date: formData.get('enlistment_date'),
                discharge_date: formData.get('discharge_date'),
                arrival_date: formData.get('arrival_date'),
                marital_status: formData.get('marital_status'),
                course_cycle: formData.get('course_cycle'),
                notes: formData.get('notes')
            };

            try {
                const url = editId ? `${API_BASE}/personnel/${editId}` : `${API_BASE}/personnel`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(personnelData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '×ª×™×§ ××™×©×™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '×ª×™×§ ××™×©×™ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadPersonnelData(); // Refresh the personnel table
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×™×§ ××™×©×™', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function loadPersonnelData(searchParams = {}) {
            try {
                const queryString = new URLSearchParams(searchParams).toString();
                const url = queryString ? `${API_BASE}/personnel?${queryString}` : `${API_BASE}/personnel`;
                const response = await fetch(url);
                if (response.ok) {
                    const personnel = await response.json();
                    updatePersonnelTable(personnel);
                } else {
                    console.error('Error loading personnel:', response.status);
                }
            } catch (error) {
                console.error('Error loading personnel:', error);
            }
        }

        // Debounced search function
        let searchTimeout;
        function debounceSearch(searchTerm) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(searchTerm);
            }, 300); // 300ms delay
        }

        function performSearch(searchTerm) {
            const searchParams = {};
            if (searchTerm.trim()) {
                searchParams.search = searchTerm.trim();
            }
            loadPersonnelData(searchParams);
        }

        function updatePersonnelTable(personnel) {
            const tbody = document.querySelector('#personnelTable');
            if (!tbody) return;

            tbody.innerHTML = personnel.map(person => `
                <tr>
                    <td><input type="checkbox" class="personnel-checkbox" data-person-id="${person.id}" onchange="updateBulkPersonnelActions()"></td>
                    <td>${person.full_name}</td>
                    <td>${person.personal_number}</td>
                    <td>${person.rank}</td>
                    <td>${person.branch || '-'}</td>
                    <td>${person.department_name || '×œ× ××©×•×™×š'}</td>
                    <td>${person.population_name || '×œ× ××©×•×™×š'}</td>
                    <td>${person.residence || '-'}</td>
                    <td>${person.arrival_date ? new Date(person.arrival_date).toLocaleDateString('he-IL') : '-'}</td>
                    <td>${person.marital_status || '-'}</td>
                    <td>
                        <button class="btn-icon" onclick="editPersonnel(${person.id})" title="×¢×¨×™×›×ª ×ª×™×§ ××™×©×™">âœï¸</button>
                        <button class="btn-icon" onclick="showPersonSkillsModal(${person.id}, '${person.full_name}')" title="× ×™×”×•×œ ×›×©×™×¨×•×™×•×ª">ğŸ¯</button>
                        <button class="btn-icon" onclick="deletePersonnel(${person.id})" title="××—×™×§×ª ×ª×™×§">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;

            if (type === 'success') {
                toast.style.background = 'var(--success)';
            } else if (type === 'error') {
                toast.style.background = 'var(--danger)';
            } else {
                toast.style.background = 'var(--info)';
            }

            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // ========== POPULATIONS FUNCTIONS ==========
        
        function showPopulationModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ××•×›×œ×•×¡×™×™×”' : '×”×•×¡×¤×ª ××•×›×œ×•×¡×™×™×” ×—×“×©×”';
            modalBody.innerHTML = `
                <form onsubmit="handlePopulationSubmit(event, ${editId})">
                    <div class="form-group">
                        <label class="form-label">×©× ××•×›×œ×•×¡×™×™×” *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ××•×›×œ×•×¡×™×™×”</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
        }

        async function handlePopulationSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const populationData = {
                name: formData.get('name'),
                notes: formData.get('notes')
            };

            try {
                const url = editId ? `${API_BASE}/populations/${editId}` : `${API_BASE}/populations`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(populationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '××•×›×œ×•×¡×™×™×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '××•×›×œ×•×¡×™×™×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadPopulationsData();
                    loadPersonnelData(); // Refresh personnel to show updated population names
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•×›×œ×•×¡×™×™×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function loadPopulationsData() {
            try {
                const response = await fetch(`${API_BASE}/populations`);
                if (response.ok) {
                    const populations = await response.json();
                    updatePopulationsTable(populations);
                }
            } catch (error) {
                console.error('Error loading populations:', error);
            }
        }

        function updatePopulationsTable(populations) {
            const tbody = document.querySelector('#populationsTable');
            if (!tbody) return;

            tbody.innerHTML = populations.map(population => `
                <tr>
                    <td>${population.name}</td>
                    <td>${population.notes || '-'}</td>
                    <td>
                        <button class="btn-icon" onclick="editPopulation(${population.id})">âœï¸</button>
                        <button class="btn-icon" onclick="deletePopulation(${population.id})" 
                                ${population.person_count > 0 ? 'disabled title="×œ× × ×™×ª×Ÿ ×œ××—×•×§ - ×™×© ×× ×©×™× ××©×•×™×›×™×"' : ''}>ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        async function editPopulation(id) {
            try {
                const response = await fetch(`${API_BASE}/populations/${id}`);
                if (response.ok) {
                    const population = await response.json();
                    showPopulationModal(id);
                    
                    // Fill form with current data
                    setTimeout(() => {
                        const form = document.querySelector('#genericModal form');
                        if (form) {
                            form.name.value = population.name;
                            form.notes.value = population.notes || '';
                        }
                    }, 100);
                } else {
                    showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××•×›×œ×•×¡×™×™×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function deletePopulation(id) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×›×œ×•×¡×™×™×” ×–×•?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/populations/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('××•×›×œ×•×¡×™×™×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    loadPopulationsData();
                    loadPersonnelData(); // Refresh personnel data
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ××•×›×œ×•×¡×™×™×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== PERSONNEL EDIT/DELETE FUNCTIONS ==========
        
        async function editPersonnel(id) {
            try {
                const response = await fetch(`${API_BASE}/personnel/${id}`);
                if (response.ok) {
                    const person = await response.json();
                    showPersonnelModal(id);
                    
                    // Fill form with current data
                    setTimeout(() => {
                        const form = document.querySelector('#genericModal form');
                        if (form) {
                            form.full_name.value = person.full_name || '';
                            form.personal_number.value = person.personal_number || '';
                            form.rank.value = person.rank || '';
                            form.branch.value = person.branch || '';
                            form.residence.value = person.residence || '';
                            form.phone.value = person.phone || '';
                            form.population_id.value = person.population_id || '';
                            form.department_id.value = person.department_id || '';
                            form.id_number.value = person.id_number || '';
                            form.birth_date.value = person.birth_date || '';
                            form.enlistment_date.value = person.enlistment_date || '';
                            form.discharge_date.value = person.discharge_date || '';
                            form.arrival_date.value = person.arrival_date || '';
                            form.marital_status.value = person.marital_status || '';
                            form.course_cycle.value = person.course_cycle || '';
                            form.notes.value = person.notes || '';
                            
                            // Update modal title and button
                            document.getElementById('modalTitle').textContent = '×¢×¨×™×›×ª ×ª×™×§ ××™×©×™';
                            const submitBtn = form.querySelector('button[type="submit"]');
                            if (submitBtn) {
                                submitBtn.textContent = '×¢×“×›×Ÿ ×ª×™×§ ××™×©×™';
                            }
                            // Set edit ID on form for handlePersonnelSubmit
                            form.setAttribute('data-edit-id', id);
                        }
                    }, 200);
                } else {
                    showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×ª×™×§ ×”××™×©×™', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function deletePersonnel(id) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×™×§ ××™×©×™ ×–×”?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/personnel/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('×ª×™×§ ××™×©×™ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
                    loadPersonnelData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ×ª×™×§ ××™×©×™', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // Bulk Actions Functions
        function toggleSelectAllPersonnel() {
            const selectAll = document.getElementById('selectAllPersonnel');
            const checkboxes = document.querySelectorAll('.personnel-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkPersonnelActions();
        }

        function updateBulkPersonnelActions() {
            const selectedCheckboxes = document.querySelectorAll('.personnel-checkbox:checked');
            const bulkActionsBar = document.getElementById('personnelBulkActions');
            const countSpan = document.getElementById('selectedPersonnelCount');
            
            if (selectedCheckboxes.length > 0) {
                bulkActionsBar.style.display = 'block';
                countSpan.textContent = `${selectedCheckboxes.length} × ×‘×—×¨×•`;
            } else {
                bulkActionsBar.style.display = 'none';
            }
        }

        function getSelectedPersonnelIds() {
            const selectedCheckboxes = document.querySelectorAll('.personnel-checkbox:checked');
            return Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-person-id'));
        }

        async function bulkAddToPopulation() {
            const selectedIds = getSelectedPersonnelIds();
            if (selectedIds.length === 0) return;
            
            try {
                const response = await fetch(`${API_BASE}/populations`);
                if (!response.ok) throw new Error('Failed to load populations');
                const populations = await response.json();
                
                showBulkPopulationModal(selectedIds, populations);
            } catch (error) {
                console.error('Failed to load populations:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×›×œ×•×¡×™×•×ª', 'error');
            }
        }

        function showBulkPopulationModal(selectedIds, populations) {
            const modalContent = `
                <form id="bulkPopulationForm">
                    <div class="form-group">
                        <label class="form-label">×‘×—×¨ ××•×›×œ×•×¡×™×™×”</label>
                        <select class="form-select" name="population_id" required>
                            <option value="">×‘×—×¨ ××•×›×œ×•×¡×™×™×”</option>
                            ${populations.map(pop => `<option value="${pop.id}">${pop.name}</option>`).join('')}
                        </select>
                    </div>
                    <p class="text-muted">×¤×¢×•×œ×” ×–×• ×ª×¢×“×›×Ÿ ××ª ×”××•×›×œ×•×¡×™×™×” ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™× × ×‘×—×¨×™×</p>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">×¢×“×›×Ÿ ××•×›×œ×•×¡×™×™×”</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                    </div>
                </form>
            `;
            
            showModal('×¢×“×›×•×Ÿ ××•×›×œ×•×¡×™×™×” - ×¤×¢×•×œ×” ×§×‘×•×¦×ª×™×ª', modalContent);
            
            document.getElementById('bulkPopulationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const populationId = formData.get('population_id');
                
                try {
                    await Promise.all(selectedIds.map(personId => 
                        fetch(`${API_BASE}/personnel/${personId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ population_id: populationId })
                        })
                    ));
                    
                    showToast(`××•×›×œ×•×¡×™×™×” ×¢×•×“×›× ×” ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™×`, 'success');
                    closeModal();
                    loadPersonnelData();
                } catch (error) {
                    console.error('Failed to update population:', error);
                    showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××•×›×œ×•×¡×™×™×”', 'error');
                }
            });
        }

        async function bulkAddToDepartment() {
            const selectedIds = getSelectedPersonnelIds();
            if (selectedIds.length === 0) return;
            
            try {
                const response = await fetch(`${API_BASE}/departments`);
                if (!response.ok) throw new Error('Failed to load departments');
                const departments = await response.json();
                
                showBulkDepartmentModal(selectedIds, departments);
            } catch (error) {
                console.error('Failed to load departments:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ××—×œ×§×•×ª', 'error');
            }
        }

        function showBulkDepartmentModal(selectedIds, departments) {
            const modalContent = `
                <form id="bulkDepartmentForm">
                    <div class="form-group">
                        <label class="form-label">×‘×—×¨ ××—×œ×§×”</label>
                        <select class="form-select" name="department_id" required>
                            <option value="">×‘×—×¨ ××—×œ×§×”</option>
                            ${departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('')}
                        </select>
                    </div>
                    <p class="text-muted">×¤×¢×•×œ×” ×–×• ×ª×¢×“×›×Ÿ ××ª ×”××—×œ×§×” ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™× × ×‘×—×¨×™×</p>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">×¢×“×›×Ÿ ××—×œ×§×”</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                    </div>
                </form>
            `;
            
            showModal('×¢×“×›×•×Ÿ ××—×œ×§×” - ×¤×¢×•×œ×” ×§×‘×•×¦×ª×™×ª', modalContent);
            
            document.getElementById('bulkDepartmentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const departmentId = formData.get('department_id');
                
                try {
                    await Promise.all(selectedIds.map(personId => 
                        fetch(`${API_BASE}/personnel/${personId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department_id: departmentId })
                        })
                    ));
                    
                    showToast(`××—×œ×§×” ×¢×•×“×›× ×” ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™×`, 'success');
                    closeModal();
                    loadPersonnelData();
                } catch (error) {
                    console.error('Failed to update department:', error);
                    showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××—×œ×§×”', 'error');
                }
            });
        }

        async function bulkAddQualification() {
            const selectedIds = getSelectedPersonnelIds();
            if (selectedIds.length === 0) return;
            
            try {
                const response = await fetch(`${API_BASE}/skills`);
                if (!response.ok) throw new Error('Failed to load skills');
                const skills = await response.json();
                
                showBulkQualificationModal(selectedIds, skills);
            } catch (error) {
                console.error('Failed to load skills:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª', 'error');
            }
        }

        function showBulkQualificationModal(selectedIds, skills) {
            const modalContent = `
                <form id="bulkQualificationForm">
                    <div class="form-group">
                        <label class="form-label">×‘×—×¨ ×›×©×™×¨×•×ª</label>
                        <select class="form-select" name="skill_id" required>
                            <option value="">×‘×—×¨ ×›×©×™×¨×•×ª</option>
                            ${skills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×¡×˜×˜×•×¡</label>
                        <select class="form-select" name="status" required>
                            <option value="××•×¡××š ×›×©×™×¨">××•×¡××š ×›×©×™×¨</option>
                            <option value="×‘×ª×”×œ×™×š ×”×¡××›×”">×‘×ª×”×œ×™×š ×”×¡××›×”</option>
                            <option value="× ×›×©×œ">× ×›×©×œ</option>
                            <option value="×¤×’ ×ª×•×§×£">×¤×’ ×ª×•×§×£</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š ×”×ª×—×œ×ª ×”×›×©×¨×”</label>
                        <input type="date" class="form-input" name="training_start_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š ×¡×™×•× ×”×›×©×¨×”</label>
                        <input type="date" class="form-input" name="training_end_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š ×¤×§×™×¢×”</label>
                        <input type="date" class="form-input" name="expiry_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3"></textarea>
                    </div>
                    <p class="text-muted">×¤×¢×•×œ×” ×–×• ×ª×•×¡×™×£ ×›×©×™×¨×•×ª ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™× × ×‘×—×¨×™×</p>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">×”×•×¡×£ ×›×©×™×¨×•×ª</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                    </div>
                </form>
            `;
            
            showModal('×”×•×¡×¤×ª ×›×©×™×¨×•×ª - ×¤×¢×•×œ×” ×§×‘×•×¦×ª×™×ª', modalContent);
            
            document.getElementById('bulkQualificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const qualificationData = Object.fromEntries(formData.entries());
                
                try {
                    await Promise.all(selectedIds.map(personId => 
                        fetch(`${API_BASE}/personnel/${personId}/skills`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(qualificationData)
                        })
                    ));
                    
                    showToast(`×›×©×™×¨×•×ª × ×•×¡×¤×” ×¢×‘×•×¨ ${selectedIds.length} ×ª×™×§×™× ××™×©×™×™×`, 'success');
                    closeModal();
                    loadPersonnelData();
                } catch (error) {
                    console.error('Failed to add qualification:', error);
                    showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×›×©×™×¨×•×ª', 'error');
                }
            });
        }

        // Personnel Filtering Functions
        async function loadPersonnelFilters() {
            try {
                const [departments, populations, skills] = await Promise.all([
                    fetch(`${API_BASE}/departments`).then(r => r.json()),
                    fetch(`${API_BASE}/populations`).then(r => r.json()),
                    fetch(`${API_BASE}/skills`).then(r => r.json())
                ]);
                
                // Populate department filter
                const departmentSelect = document.getElementById('departmentFilter');
                departmentSelect.innerHTML = '<option value="">×›×œ ×”××—×œ×§×•×ª</option>' +
                    departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
                
                // Populate population filter
                const populationSelect = document.getElementById('populationFilter');
                populationSelect.innerHTML = '<option value="">×›×œ ×”××•×›×œ×•×¡×™×•×ª</option>' +
                    populations.map(pop => `<option value="${pop.id}">${pop.name}</option>`).join('');
                
                // Populate qualification filter
                const qualificationSelect = document.getElementById('qualificationFilter');
                qualificationSelect.innerHTML = '<option value="">×›×œ ×”×›×©×™×¨×•×™×•×ª</option>' +
                    skills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('');
                    
            } catch (error) {
                console.error('Failed to load filter options:', error);
            }
        }

        function applyPersonnelFilters() {
            const searchText = document.getElementById('personnelSearch').value.trim();
            const departmentId = document.getElementById('departmentFilter').value;
            const populationId = document.getElementById('populationFilter').value;
            const qualificationId = document.getElementById('qualificationFilter').value;
            
            // Apply global search filter
            if (searchText) {
                currentFilters['global_search'] = searchText;
            } else {
                delete currentFilters['global_search'];
            }
            
            // Apply department filter by name (not ID)
            if (departmentId) {
                // Find department name by ID
                const deptSelect = document.getElementById('departmentFilter');
                const selectedOption = deptSelect.options[deptSelect.selectedIndex];
                if (selectedOption && selectedOption.text !== '×›×œ ×”××—×œ×§×•×ª') {
                    currentFilters['department_name'] = selectedOption.text;
                }
            } else {
                delete currentFilters['department_name'];
            }
            
            // Apply population filter by name (not ID)
            if (populationId) {
                const popSelect = document.getElementById('populationFilter');
                const selectedOption = popSelect.options[popSelect.selectedIndex];
                if (selectedOption && selectedOption.text !== '×›×œ ×”××•×›×œ×•×¡×™×•×ª') {
                    currentFilters['population_name'] = selectedOption.text;
                }
            } else {
                delete currentFilters['population_name'];
            }
            
            // Apply qualification filter (this would require server-side support for now)
            if (qualificationId) {
                // For now, we'll implement this as a simple filter
                // In a full implementation, this would require joining with skills table
                currentFilters['qualification_filter'] = qualificationId;
            } else {
                delete currentFilters['qualification_filter'];
            }
            
            applyFiltersAndSort();
        }

        function clearPersonnelFilters() {
            document.getElementById('personnelSearch').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('populationFilter').value = '';
            document.getElementById('qualificationFilter').value = '';
            
            clearAllFilters();
        }

        // Load populations for personnel form dropdown
        async function loadPopulationsForSelect() {
            try {
                const response = await fetch(`${API_BASE}/populations`);
                if (response.ok) {
                    const populations = await response.json();
                    const select = document.getElementById('populationSelect');
                    if (select) {
                        select.innerHTML = '<option value="">×‘×—×¨ ××•×›×œ×•×¡×™×™×” (××•×¤×¦×™×•× ×œ×™)</option>' + 
                            populations.map(pop => `<option value="${pop.id}">${pop.name}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading populations for select:', error);
            }
        }

        // Handle department selection - automatically treat as department soldier
        function handleDepartmentSelection() {
            const departmentSelect = document.getElementById('departmentSelect');
            const departmentValue = departmentSelect.value;
            
            if (departmentValue) {
                // When a department is selected, the person is automatically a department soldier
                // This is just a UI indication - the API already handles is_commander = false by default
                console.log(`Person assigned to department ID: ${departmentValue} as department soldier`);
            }
        }

        // Load departments for personnel form dropdown
        async function loadDepartmentsForSelect() {
            try {
                const response = await fetch(`${API_BASE}/departments`);
                if (response.ok) {
                    const departments = await response.json();
                    const select = document.getElementById('departmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">×‘×—×¨ ××—×œ×§×” (××•×¤×¦×™×•× ×œ×™)</option>' + 
                            departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading departments for select:', error);
            }
        }

        // Update personnel modal to support editing
        async function showPersonnelModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×ª×™×§ ××™×©×™' : '×”×•×¡×¤×ª ×ª×™×§ ××™×©×™ ×—×“×©';
            modalBody.innerHTML = `
                <form onsubmit="handlePersonnelSubmit(event)" data-edit-id="${editId || ''}" style="max-height: 70vh; overflow-y: auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">×©× ××œ× *</label>
                            <input type="text" class="form-input" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡×¤×¨ ××™×©×™ *</label>
                            <input type="text" class="form-input" name="personal_number" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×“×¨×’×” *</label>
                            <select class="form-select" name="rank" required>
                                <option value="">×‘×—×¨ ×“×¨×’×”</option>
                                <option value="×¨×‘×´×˜">×¨×‘×´×˜</option>
                                <option value="×¡××œ">×¡××œ</option>
                                <option value="×¡××´×¨">×¡××´×¨</option>
                                <option value="×¨×¡×´×¨">×¨×¡×´×¨</option>
                                <option value="×¨×‘×´×¡">×¨×‘×´×¡</option>
                                <option value="×¨×‘×´×—">×¨×‘×´×—</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×’×£ *</label>
                            <input type="text" class="form-input" name="branch" required placeholder="×ª×§×©×•×¨×ª, ××‘×¦×¢×™×, ×¡×™×™×‘×¨...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">××§×•× ××’×•×¨×™× *</label>
                            <input type="text" class="form-input" name="residence" required placeholder="×ª×œ ××‘×™×‘, ×™×¨×•×©×œ×™×...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡×¤×¨ ×˜×œ×¤×•×Ÿ *</label>
                            <input type="tel" class="form-input" name="phone" required placeholder="050-1234567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">××•×›×œ×•×¡×™×™×”</label>
                            <select class="form-select" name="population_id" id="populationSelect">
                                <option value="">×‘×—×¨ ××•×›×œ×•×¡×™×™×” (××•×¤×¦×™×•× ×œ×™)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××—×œ×§×”</label>
                            <select class="form-select" name="department_id" id="departmentSelect" onchange="handleDepartmentSelection()">
                                <option value="">×‘×—×¨ ××—×œ×§×” (××•×¤×¦×™×•× ×œ×™)</option>
                            </select>
                            <small style="color: var(--text-muted); margin-top: 4px;">×‘×—×™×¨×ª ××—×œ×§×” ×”×•×¤×›×ª ××ª ×”××“× ×œ×—×™×™×œ ××—×œ×§×”</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª×¢×•×“×ª ×–×”×•×ª *</label>
                            <input type="text" class="form-input" name="id_number" required pattern="[0-9]{9}" placeholder="123456789">
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×œ×™×“×” *</label>
                            <input type="date" class="form-input" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×’×™×•×¡ *</label>
                            <input type="date" class="form-input" name="enlistment_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×©×—×¨×•×¨ *</label>
                            <input type="date" class="form-input" name="discharge_date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×ª××¨×™×š ×”×’×¢×” ×œ××¨×’×•×Ÿ</label>
                            <input type="date" class="form-input" name="arrival_date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">×¡×˜×˜×•×¡ ××©×¤×—×ª×™ *</label>
                            <select class="form-select" name="marital_status" required>
                                <option value="">×‘×—×¨ ×¡×˜×˜×•×¡</option>
                                <option value="×¨×•×•×§">×¨×•×•×§</option>
                                <option value="× ×©×•×™">× ×©×•×™</option>
                                <option value="××œ××Ÿ">××œ××Ÿ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××—×–×•×¨ ×§×•×¨×¡/×§×§×´×¥ *</label>
                            <input type="text" class="form-input" name="course_cycle" required placeholder="××—×–×•×¨ 156">
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">
                            ${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×ª×™×§ ××™×©×™
                        </button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
            
            // Load populations and departments for the select dropdowns
            loadPopulationsForSelect();
            loadDepartmentsForSelect();
        }

        // Handle personnel form submission
        async function handlePersonnelSubmit(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const formData = new FormData(form);
            const editId = form.getAttribute('data-edit-id');

            const personnelData = {
                full_name: formData.get('full_name'),
                personal_number: formData.get('personal_number'),
                rank: formData.get('rank'),
                branch: formData.get('branch'),
                residence: formData.get('residence'),
                phone: formData.get('phone'),
                population_id: formData.get('population_id') || null,
                department_id: formData.get('department_id') || null,
                id_number: formData.get('id_number'),
                birth_date: formData.get('birth_date'),
                enlistment_date: formData.get('enlistment_date'),
                discharge_date: formData.get('discharge_date'),
                arrival_date: formData.get('arrival_date') || null,
                marital_status: formData.get('marital_status'),
                course_cycle: formData.get('course_cycle'),
                notes: formData.get('notes') || null
            };

            try {
                const url = editId ? `${API_BASE}/personnel/${editId}` : `${API_BASE}/personnel`;
                const method = editId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(personnelData)
                });

                if (response.ok) {
                    showToast(editId ? '×ª×™×§ ××™×©×™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '×ª×™×§ ××™×©×™ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadPersonnelData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×©××™×¨×ª ×ª×™×§ ××™×©×™', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== DEPARTMENTS CRUD FUNCTIONS ==========
        
        function showDepartmentModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ××—×œ×§×”' : '×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”';
            modalBody.innerHTML = `
                <form onsubmit="handleDepartmentSubmit(event)" data-edit-id="${editId || ''}">
                    <div class="form-group">
                        <label class="form-label">×©× ××—×œ×§×” *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">××¤×§×“ ××—×œ×§×” *</label>
                        <select class="form-select" name="commander_id" id="commanderSelect" required>
                            <option value="">×‘×—×¨ ××¤×§×“ ××—×œ×§×”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×—×™×™×œ×™ ××—×œ×§×” * (×œ×¤×—×•×ª 1)</label>
                        <div id="soldierSelectContainer" style="border: 1px solid var(--border); border-radius: 4px; padding: 8px; max-height: 200px; overflow-y: auto;">
                            <div style="margin-bottom: 8px;">
                                <input type="text" id="soldierSearch" placeholder="×—×¤×© ×—×™×™×œ..." style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px;">
                            </div>
                            <div id="soldierCheckboxes">
                                <!-- Dynamic checkboxes will be populated here -->
                            </div>
                        </div>
                        <small style="color: var(--text-muted);">×—×•×‘×” ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×—×™×™×œ ××—×“</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ××—×œ×§×”</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
            
            // Load personnel for both commander and soldiers selection
            loadPersonnelForDepartment();
        }

        async function handleDepartmentSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Collect selected soldiers
            const selectedSoldiers = [];
            const soldierCheckboxes = document.querySelectorAll('#soldierCheckboxes input[type="checkbox"]:checked');
            soldierCheckboxes.forEach(checkbox => {
                selectedSoldiers.push(parseInt(checkbox.value));
            });
            
            // Validation
            if (!formData.get('commander_id')) {
                showToast('×™×© ×œ×‘×—×•×¨ ××¤×§×“ ××—×œ×§×”', 'error');
                return;
            }
            
            if (selectedSoldiers.length === 0) {
                showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×—×™×™×œ ××—×“', 'error');
                return;
            }
            
            const departmentData = {
                name: formData.get('name'),
                commander_id: parseInt(formData.get('commander_id')),
                soldier_ids: selectedSoldiers,
                notes: formData.get('notes')
            };

            try {
                const url = editId ? `${API_BASE}/departments/${editId}` : `${API_BASE}/departments`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(departmentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '××—×œ×§×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '××—×œ×§×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadDepartmentsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // Load personnel for department creation/editing
        async function loadPersonnelForDepartment() {
            try {
                const response = await fetch(`${API_BASE}/personnel`);
                if (response.ok) {
                    const personnel = await response.json();
                    
                    // Populate commander dropdown
                    const commanderSelect = document.getElementById('commanderSelect');
                    if (commanderSelect) {
                        commanderSelect.innerHTML = '<option value="">×‘×—×¨ ××¤×§×“ ××—×œ×§×”</option>' +
                            personnel.map(person => `<option value="${person.id}">${person.full_name} (${person.rank})</option>`).join('');
                    }
                    
                    // Populate soldiers checkboxes
                    populateSoldierCheckboxes(personnel);
                    
                    // Add search functionality
                    setupSoldierSearch(personnel);
                }
            } catch (error) {
                console.error('Error loading personnel for department:', error);
            }
        }
        
        // Populate soldier checkboxes
        function populateSoldierCheckboxes(personnel) {
            const soldierCheckboxes = document.getElementById('soldierCheckboxes');
            if (!soldierCheckboxes) return;
            
            soldierCheckboxes.innerHTML = personnel.map(person => `
                <div class="soldier-checkbox" style="padding: 4px 0; border-bottom: 1px solid var(--border-light);">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${person.id}" style="margin-left: 8px;">
                        <span style="font-weight: 500;">${person.full_name}</span>
                        <span style="color: var(--text-muted); margin-right: 8px;">(${person.rank})</span>
                    </label>
                </div>
            `).join('');
        }
        
        // Setup soldier search functionality
        function setupSoldierSearch(personnel) {
            const searchInput = document.getElementById('soldierSearch');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const checkboxes = document.querySelectorAll('.soldier-checkbox');
                
                checkboxes.forEach(checkbox => {
                    const text = checkbox.textContent.toLowerCase();
                    checkbox.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }

        async function loadDepartmentsData() {
            try {
                const response = await fetch(`${API_BASE}/departments`);
                if (response.ok) {
                    const departments = await response.json();
                    
                    // Fetch members for each department
                    const departmentsWithMembers = await Promise.all(
                        departments.map(async (dept) => {
                            try {
                                const membersResponse = await fetch(`${API_BASE}/departments/${dept.id}/members`);
                                if (membersResponse.ok) {
                                    const members = await membersResponse.json();
                                    // Filter out commander from soldiers list
                                    dept.soldiers = members.filter(member => !member.is_commander);
                                } else {
                                    dept.soldiers = [];
                                }
                            } catch (error) {
                                console.error(`Error loading members for department ${dept.id}:`, error);
                                dept.soldiers = [];
                            }
                            return dept;
                        })
                    );
                    
                    updateDepartmentsDisplay(departmentsWithMembers);
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        function updateDepartmentsDisplay(departments) {
            const container = document.getElementById('departmentsContainer');
            if (!container) return;

            container.innerHTML = departments.map(dept => `
                <div class="department-card">
                    <div class="department-header">
                        <div class="department-name">${dept.name}</div>
                        <div class="department-count">${dept.member_count || 0} ×× ×©×™×</div>
                    </div>
                    <div class="department-details">
                        <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ${dept.commander_name || '×œ× ××•×’×“×¨'}</p>
                        <p><strong>×”×¢×¨×•×ª:</strong> ${dept.notes || '×œ×œ× ×”×¢×¨×•×ª'}</p>
                        ${dept.soldiers && dept.soldiers.length > 0 ? `
                            <div style="margin-top: 12px;">
                                <strong>×—×™×™×œ×™×:</strong>
                                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${dept.soldiers.map(soldier => `
                                        <span style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid var(--border);">
                                            ${soldier.full_name} (${soldier.rank})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="department-actions">
                        <button class="btn btn-secondary" onclick="editDepartment(${dept.id})">×¢×¨×™×›×”</button>
                        <button class="btn btn-primary" onclick="showCommanderAssignmentModal(${dept.id}, '${dept.name}')">××¤×§×“</button>
                        <button class="btn btn-danger" onclick="deleteDepartment(${dept.id})" 
                                ${dept.member_count > 0 ? 'disabled title="×œ× × ×™×ª×Ÿ ×œ××—×•×§ - ×™×© ×× ×©×™× ×‘××—×œ×§×”"' : ''}>××—×™×§×”</button>
                    </div>
                </div>
            `).join('');
        }

        async function editDepartment(id) {
            // Simply show the modal and let showDepartmentModal handle all data loading
            showDepartmentModal(id);
        }

        async function showCommanderAssignmentModal(departmentId, departmentName) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `× ×™×”×•×œ ××¤×§×“ ××—×œ×§×” - ${departmentName}`;
            modalBody.innerHTML = `
                <div id="commanderAssignmentContent">
                    <div style="text-align: center; padding: 20px;">
                        <div class="loading">×˜×•×¢×Ÿ ×× ×©×™ ××—×œ×§×”...</div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">×¡×’×•×¨</button>
                </div>
            `;
            modal.classList.add('active');
            
            // Load department personnel for commander selection
            loadDepartmentPersonnel(departmentId, departmentName);
        }

        async function loadDepartmentPersonnel(departmentId, departmentName) {
            try {
                const [deptResponse, personnelResponse] = await Promise.all([
                    fetch(`${API_BASE}/departments/${departmentId}`),
                    fetch(`${API_BASE}/personnel?department_id=${departmentId}`)
                ]);
                
                if (deptResponse.ok && personnelResponse.ok) {
                    const department = await deptResponse.json();
                    const personnel = await personnelResponse.json();
                    
                    updateCommanderAssignmentContent(departmentId, departmentName, department, personnel);
                } else {
                    document.getElementById('commanderAssignmentContent').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</p>';
                }
            } catch (error) {
                console.error('Error loading department personnel:', error);
                document.getElementById('commanderAssignmentContent').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª</p>';
            }
        }

        function updateCommanderAssignmentContent(departmentId, departmentName, department, personnel) {
            const container = document.getElementById('commanderAssignmentContent');
            if (!container) return;

            if (personnel.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">××™×Ÿ ×× ×©×™× ×‘××—×œ×§×” ×–×•</p>';
                return;
            }

            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">×‘×—×¨ ××¤×§×“ ××—×œ×§×”:</label>
                    <select class="form-select" id="commanderSelect" onchange="handleCommanderChange(${departmentId})">
                        <option value="">×œ×œ× ××¤×§×“</option>
                        ${personnel.map(person => `
                            <option value="${person.id}" ${department.commander_id == person.id ? 'selected' : ''}>
                                ${person.full_name} - ${person.rank}
                            </option>
                        `).join('')}
                    </select>
                </div>
                ${department.commander_id ? `
                    <div class="form-group">
                        <button class="btn btn-danger" onclick="removeCommander(${departmentId})">
                            ×”×¡×¨ ××¤×§×“ × ×•×›×—×™
                        </button>
                    </div>
                ` : ''}
            `;
        }

        async function handleCommanderChange(departmentId) {
            const select = document.getElementById('commanderSelect');
            const personId = select.value;
            
            if (!personId) return;
            
            try {
                const response = await fetch(`${API_BASE}/departments/${departmentId}/commander`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ person_id: personId })
                });

                if (response.ok) {
                    showToast('××¤×§×“ ××—×œ×§×” × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    loadDepartmentsData(); // Refresh departments display
                    loadDepartmentPersonnel(departmentId, '××—×œ×§×”'); // Refresh commander assignment modal
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×”×•×¡×¤×ª ××¤×§×“ ××—×œ×§×”', 'error');
                    select.value = ''; // Reset selection
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
                select.value = ''; // Reset selection
            }
        }

        async function removeCommander(departmentId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ××¤×§×“ ×”××—×œ×§×”?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/departments/${departmentId}/commander`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('××¤×§×“ ××—×œ×§×” ×”×•×¡×¨ ×‘×”×¦×œ×—×”!', 'success');
                    loadDepartmentsData(); // Refresh departments display
                    loadDepartmentPersonnel(departmentId, '××—×œ×§×”'); // Refresh commander assignment modal
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×”×¡×¨×ª ××¤×§×“ ××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××—×œ×§×” ×–×•?\n\n×©×™× ×œ×‘: ×™×© ×œ×”×¢×‘×™×¨ ××ª ×›×œ ×”×× ×©×™× ××”××—×œ×§×” ×œ×¤× ×™ ×”××—×™×§×”.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/departments/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('××—×œ×§×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    loadDepartmentsData();
                } else {
                    const error = await response.json();
                    showToast(`${error.error}${error.assigned_count ? ` (${error.assigned_count} ×× ×©×™×)` : ''}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== SKILLS FUNCTIONS ==========
        
        function showSkillModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×›×©×™×¨×•×ª' : '×”×•×¡×¤×ª ×›×©×™×¨×•×ª ×—×“×©×”';
            modalBody.innerHTML = `
                <form onsubmit="handleSkillSubmit(event, ${editId})">
                    <div class="form-group">
                        <label class="form-label">×©× ×›×©×™×¨×•×ª *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×›×©×™×¨×•×ª</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
        }

        async function handleSkillSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const skillData = {
                name: formData.get('name'),
                notes: formData.get('notes')
            };

            try {
                const url = editId ? `${API_BASE}/skills/${editId}` : `${API_BASE}/skills`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(skillData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '×›×©×™×¨×•×ª ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '×›×©×™×¨×•×ª × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadSkillsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function loadSkillsData() {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                if (response.ok) {
                    const skills = await response.json();
                    
                    // Fetch people for each skill
                    const skillsWithPeople = await Promise.all(
                        skills.map(async (skill) => {
                            try {
                                const peopleResponse = await fetch(`${API_BASE}/skills/${skill.id}/people`);
                                if (peopleResponse.ok) {
                                    skill.people = await peopleResponse.json();
                                } else {
                                    skill.people = [];
                                }
                            } catch (error) {
                                console.error(`Error loading people for skill ${skill.id}:`, error);
                                skill.people = [];
                            }
                            return skill;
                        })
                    );
                    
                    updateSkillsTable(skillsWithPeople);
                }
            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        function updateSkillsTable(skills) {
            const tbody = document.querySelector('#skillsTable');
            if (!tbody) return;

            tbody.innerHTML = skills.map(skill => `
                <tr>
                    <td>
                        <div style="font-weight: 500; margin-bottom: 4px;">${skill.name}</div>
                        ${skill.people && skill.people.length > 0 ? `
                            <div style="margin-top: 8px;">
                                <strong style="font-size: 12px; color: var(--text-secondary);">××•×¡××›×™×:</strong>
                                <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${skill.people.map(person => `
                                        <span style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid var(--border);">
                                            ${person.full_name} (${person.rank})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </td>
                    <td>${skill.notes || '-'}</td>
                    <td>
                        <button class="btn-icon" onclick="editSkill(${skill.id})">âœï¸</button>
                        <button class="btn-icon" onclick="deleteSkill(${skill.id})" 
                                ${skill.person_count > 0 ? 'disabled title="×œ× × ×™×ª×Ÿ ×œ××—×•×§ - ×™×© ×× ×©×™× ×¢× ×›×©×™×¨×•×ª ×–×•"' : ''}>ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        async function editSkill(id) {
            try {
                const response = await fetch(`${API_BASE}/skills/${id}`);
                if (response.ok) {
                    const skill = await response.json();
                    showSkillModal(id);
                    
                    // Fill form with current data
                    setTimeout(() => {
                        const form = document.querySelector('#genericModal form');
                        if (form) {
                            form.name.value = skill.name;
                            form.notes.value = skill.notes || '';
                        }
                    }, 100);
                } else {
                    showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function deleteSkill(id) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×›×©×™×¨×•×ª ×–×•?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/skills/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('×›×©×™×¨×•×ª × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    loadSkillsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== PERSONNEL QUALIFICATIONS FUNCTIONS ==========
        
        function showAddQualificationModal(personId, personName) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `×”×•×¡×¤×ª ×›×©×™×¨×•×ª ×œ${personName}`;
            
            modalBody.innerHTML = `
                <form onsubmit="handleQualificationSubmit(event, ${personId})" id="qualificationForm">
                    <div class="form-group">
                        <label class="form-label">×›×©×™×¨×•×ª *</label>
                        <select class="form-input" name="skill_id" id="skillSelect" required>
                            <option value="">×‘×—×¨ ×›×©×™×¨×•×ª</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×¡×˜×˜×•×¡ *</label>
                        <select class="form-input" name="status" id="statusSelect" onchange="toggleDateFields()" required>
                            <option value="">×‘×—×¨ ×¡×˜×˜×•×¡</option>
                            <option value="××•×¡××š ×›×©×™×¨">××•×¡××š ×›×©×™×¨</option>
                            <option value="×‘×ª×”×œ×™×š ×”×¡××›×”">×‘×ª×”×œ×™×š ×”×¡××›×”</option>
                            <option value="××•×¡××š ×œ× ×›×©×™×¨">××•×¡××š ×œ× ×›×©×™×¨</option>
                        </select>
                    </div>
                    
                    <!-- Date fields that will be shown/hidden based on status -->
                    <div class="form-group" id="fitnessDateGroup" style="display: none;">
                        <label class="form-label">×ª××¨×™×š ×™×¦×™××” ××›×•×©×¨ *</label>
                        <input type="date" class="form-input" name="exit_from_fitness_date" id="fitnessDate">
                        <small style="color: var(--text-muted);">×¢×‘×•×¨ ×¡×˜×˜×•×¡ "××•×¡××š ×›×©×™×¨" ××• "××•×¡××š ×œ× ×›×©×™×¨"</small>
                    </div>
                    
                    <div class="form-group" id="trainingDatesGroup" style="display: none;">
                        <label class="form-label">×ª××¨×™×š ×”×ª×—×œ×ª ×”×¡××›×” *</label>
                        <input type="date" class="form-input" name="training_start_date" id="trainingStartDate">
                        
                        <label class="form-label" style="margin-top: 12px;">×ª××¨×™×š ×¡×™×•× ×”×¡××›×” *</label>
                        <input type="date" class="form-input" name="training_end_date" id="trainingEndDate">
                        
                        <small style="color: var(--text-muted);">×¢×‘×•×¨ ×¡×˜×˜×•×¡ "×‘×ª×”×œ×™×š ×”×¡××›×”"</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">×”×•×¡×£ ×›×©×™×¨×•×ª</button>
                    </div>
                </form>
            `;
            
            modal.classList.add('active');
            
            // Load available skills
            loadSkillsForQualification();
        }
        
        async function loadSkillsForQualification() {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                const skillSelect = document.getElementById('skillSelect');
                
                if (response.ok) {
                    const skills = await response.json();
                    skillSelect.innerHTML = '<option value="">×‘×—×¨ ×›×©×™×¨×•×ª</option>' + 
                        skills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('');
                } else {
                    // Fallback with hardcoded skills
                    const fallbackSkills = [
                        {id: 1, name: '×ª×§×©×•×¨×ª'},
                        {id: 2, name: '×¡×™×™×‘×¨'},
                        {id: 3, name: '××‘×˜×—×ª ××™×“×¢'},
                        {id: 4, name: '× ×™×ª×•×— ××•×“×™×¢×™×Ÿ'},
                        {id: 5, name: '××¢×¨×›×•×ª ××—×©×‘'},
                        {id: 6, name: '×œ×•×’×™×¡×˜×™×§×”'},
                        {id: 7, name: '×¨×¤×•××”'},
                        {id: 8, name: '×××œ×´×—'}
                    ];
                    skillSelect.innerHTML = '<option value="">×‘×—×¨ ×›×©×™×¨×•×ª</option>' + 
                        fallbackSkills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading skills:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª', 'error');
            }
        }
        
        function toggleDateFields() {
            const statusSelect = document.getElementById('statusSelect');
            const fitnessDateGroup = document.getElementById('fitnessDateGroup');
            const trainingDatesGroup = document.getElementById('trainingDatesGroup');
            const fitnessDate = document.getElementById('fitnessDate');
            const trainingStartDate = document.getElementById('trainingStartDate');
            const trainingEndDate = document.getElementById('trainingEndDate');
            
            // Hide all date fields first
            fitnessDateGroup.style.display = 'none';
            trainingDatesGroup.style.display = 'none';
            
            // Clear required attributes
            fitnessDate.removeAttribute('required');
            trainingStartDate.removeAttribute('required');
            trainingEndDate.removeAttribute('required');
            
            // Show appropriate fields based on selected status
            switch(statusSelect.value) {
                case '××•×¡××š ×›×©×™×¨':
                case '××•×¡××š ×œ× ×›×©×™×¨':
                    fitnessDateGroup.style.display = 'block';
                    fitnessDate.setAttribute('required', '');
                    break;
                    
                case '×‘×ª×”×œ×™×š ×”×¡××›×”':
                    trainingDatesGroup.style.display = 'block';
                    trainingStartDate.setAttribute('required', '');
                    trainingEndDate.setAttribute('required', '');
                    break;
            }
        }
        
        async function handleQualificationSubmit(event, personId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const status = formData.get('status');
            const qualificationData = {
                person_id: personId,
                skill_id: parseInt(formData.get('skill_id')),
                status: status,
                notes: formData.get('notes')
            };
            
            // Add appropriate date fields based on status
            switch(status) {
                case '××•×¡××š ×›×©×™×¨':
                case '××•×¡××š ×œ× ×›×©×™×¨':
                    const fitnessDate = formData.get('exit_from_fitness_date');
                    if (!fitnessDate) {
                        showToast('×ª××¨×™×š ×™×¦×™××” ××›×•×©×¨ ×”×•× ×©×“×” ×—×•×‘×”', 'error');
                        return;
                    }
                    qualificationData.expiry_date = fitnessDate;
                    break;
                    
                case '×‘×ª×”×œ×™×š ×”×¡××›×”':
                    const startDate = formData.get('training_start_date');
                    const endDate = formData.get('training_end_date');
                    if (!startDate || !endDate) {
                        showToast('×ª××¨×™×›×™ ×”×¡××›×” ×”× ×©×“×•×ª ×—×•×‘×”', 'error');
                        return;
                    }
                    if (startDate >= endDate) {
                        showToast('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×”×¡×™×•×', 'error');
                        return;
                    }
                    qualificationData.training_start_date = startDate;
                    qualificationData.training_end_date = endDate;
                    break;
            }
            
            try {
                const response = await fetch(`${API_BASE}/personnel/${personId}/skills`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(qualificationData)
                });
                
                if (response.ok) {
                    showToast('×›×©×™×¨×•×ª × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    // Optionally refresh personnel data
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×”×•×¡×¤×ª ×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error adding qualification:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Load and display personnel data
        async function loadPersonnelData() {
            try {
                const response = await fetch(`${API_BASE}/personnel`);
                if (response.ok) {
                    const personnel = await response.json();
                    updatePersonnelDisplay(personnel);
                }
            } catch (error) {
                console.error('Error loading personnel:', error);
            }
        }
        
        function updatePersonnelDisplay(personnel) {
            const tableBody = document.getElementById('personnelTable');
            if (!tableBody) return;
            
            if (personnel.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-muted); padding: 40px;">××™×Ÿ ×ª×™×§×™× ××™×©×™×™×</td></tr>';
                return;
            }
            
            tableBody.innerHTML = personnel.map(person => `
                <tr>
                    <td><input type="checkbox" class="personnel-checkbox" value="${person.id}" onchange="updateBulkActions()"></td>
                    <td>${person.full_name}</td>
                    <td>${person.personal_number}</td>
                    <td>${person.rank}</td>
                    <td>${person.branch}</td>
                    <td>${person.department_name || '×œ× ××©×•×‘×¥'}</td>
                    <td>${person.population_name || '×œ× ××•×’×“×¨'}</td>
                    <td>${person.residence}</td>
                    <td>${person.arrival_date || person.enlistment_date}</td>
                    <td>${person.marital_status}</td>
                    <td>
                        <button class="btn-icon" onclick="editPersonnel(${person.id})" title="×¢×¨×™×›×ª ×ª×™×§ ××™×©×™">âœï¸</button>
                        <button class="btn-icon" onclick="showAddQualificationModal(${person.id}, '${person.full_name}')" title="×”×•×¡×¤×ª ×›×©×™×¨×•×ª">ğŸ“</button>
                        <button class="btn-icon" onclick="deletePersonnel(${person.id})" title="××—×™×§×ª ×ª×™×§ ××™×©×™">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // ========== PERSONNEL CHECKBOX FUNCTIONS ==========
        
        function toggleSelectAllPersonnel() {
            const selectAllCheckbox = document.getElementById('selectAllPersonnel');
            const personnelCheckboxes = document.querySelectorAll('.personnel-checkbox');
            
            personnelCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const selectedCheckboxes = document.querySelectorAll('.personnel-checkbox:checked');
            const bulkActionsBar = document.getElementById('personnelBulkActions');
            const selectedCount = document.getElementById('selectedPersonnelCount');
            const selectAllCheckbox = document.getElementById('selectAllPersonnel');
            
            if (selectedCheckboxes.length > 0) {
                bulkActionsBar.style.display = 'block';
                selectedCount.textContent = `${selectedCheckboxes.length} × ×‘×—×¨×•`;
            } else {
                bulkActionsBar.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.personnel-checkbox');
            if (allCheckboxes.length > 0) {
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
                selectAllCheckbox.checked = selectedCheckboxes.length === allCheckboxes.length;
            }
        }
        
        function getSelectedPersonnelIds() {
            return Array.from(document.querySelectorAll('.personnel-checkbox:checked')).map(cb => parseInt(cb.value));
        }

        // ========== PERSONNEL SORTING AND FILTERING ==========
        
        let currentSort = { column: null, direction: 'asc' };
        let currentFilters = {};
        let allPersonnelData = [];

        function sortTable(column) {
            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update UI indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const currentTh = document.querySelector(`[data-column="${column}"]`);
            if (currentTh) {
                currentTh.classList.add(`sort-${currentSort.direction}`);
            }

            // Apply sort and filters
            applyFiltersAndSort();
        }

        function applyColumnFilter(element) {
            const column = element.getAttribute('data-column');
            const value = element.value.trim();
            
            if (value) {
                currentFilters[column] = value;
            } else {
                delete currentFilters[column];
            }
            
            // Apply filters and sort
            applyFiltersAndSort();
        }

        function applyFiltersAndSort() {
            let filteredData = [...allPersonnelData];

            // Apply all filters
            Object.keys(currentFilters).forEach(column => {
                const filterValue = currentFilters[column].toLowerCase();
                filteredData = filteredData.filter(person => {
                    let cellValue = '';
                    
                    switch (column) {
                        case 'full_name':
                            cellValue = person.full_name || '';
                            break;
                        case 'personal_number':
                            cellValue = person.personal_number || '';
                            break;
                        case 'rank':
                            cellValue = person.rank || '';
                            break;
                        case 'branch':
                            cellValue = person.branch || '';
                            break;
                        case 'department_name':
                            cellValue = person.department_name || '';
                            break;
                        case 'population_name':
                            cellValue = person.population_name || '';
                            break;
                        case 'residence':
                            cellValue = person.residence || '';
                            break;
                        case 'arrival_date':
                            cellValue = person.arrival_date || person.enlistment_date || '';
                            // For date filtering, check if the date starts with the filter value
                            return cellValue.includes(filterValue);
                        case 'marital_status':
                            cellValue = person.marital_status || '';
                            break;
                        case 'global_search':
                            // Search across multiple fields
                            const searchFields = [
                                person.full_name,
                                person.personal_number,
                                person.rank,
                                person.branch,
                                person.department_name,
                                person.population_name,
                                person.residence
                            ].filter(Boolean).join(' ');
                            return searchFields.toLowerCase().includes(filterValue);
                        case 'qualification_filter':
                            // Filter by qualification - check if person has this skill
                            return person.skills && person.skills.some(skill => skill.skill_id == filterValue);
                        default:
                            return true;
                    }
                    
                    return cellValue.toLowerCase().includes(filterValue);
                });
            });

            // Apply sorting
            if (currentSort.column) {
                filteredData.sort((a, b) => {
                    let aVal = '', bVal = '';
                    
                    switch (currentSort.column) {
                        case 'full_name':
                            aVal = a.full_name || '';
                            bVal = b.full_name || '';
                            break;
                        case 'personal_number':
                            aVal = a.personal_number || '';
                            bVal = b.personal_number || '';
                            break;
                        case 'rank':
                            aVal = a.rank || '';
                            bVal = b.rank || '';
                            break;
                        case 'branch':
                            aVal = a.branch || '';
                            bVal = b.branch || '';
                            break;
                        case 'department_name':
                            aVal = a.department_name || '';
                            bVal = b.department_name || '';
                            break;
                        case 'population_name':
                            aVal = a.population_name || '';
                            bVal = b.population_name || '';
                            break;
                        case 'residence':
                            aVal = a.residence || '';
                            bVal = b.residence || '';
                            break;
                        case 'arrival_date':
                            aVal = a.arrival_date || a.enlistment_date || '';
                            bVal = b.arrival_date || b.enlistment_date || '';
                            break;
                        case 'marital_status':
                            aVal = a.marital_status || '';
                            bVal = b.marital_status || '';
                            break;
                        default:
                            return 0;
                    }
                    
                    // Handle special sorting cases
                    if (currentSort.column === 'arrival_date') {
                        aVal = new Date(aVal || '1900-01-01');
                        bVal = new Date(bVal || '1900-01-01');
                    } else if (currentSort.column === 'full_name') {
                        // Hebrew alphabetical sorting using Hebrew locale
                        const comparison = aVal.localeCompare(bVal, 'he', { numeric: true, sensitivity: 'base' });
                        return currentSort.direction === 'asc' ? comparison : -comparison;
                    }
                    
                    const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    return currentSort.direction === 'asc' ? comparison : -comparison;
                });
            }

            // Update the display
            updatePersonnelDisplay(filteredData);
        }

        function clearAllFilters() {
            // Clear all column filters
            document.querySelectorAll('.column-filter').forEach(input => {
                input.value = '';
            });
            
            // Clear global filters
            document.getElementById('personnelSearch').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('populationFilter').value = '';
            document.getElementById('qualificationFilter').value = '';
            
            // Reset current filters
            currentFilters = {};
            currentSort = { column: null, direction: 'asc' };
            
            // Clear sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Show all data
            updatePersonnelDisplay(allPersonnelData);
        }

        // Enhanced loadPersonnelData to store all data for client-side filtering
        async function loadPersonnelDataWithFiltering() {
            try {
                const response = await fetch(`${API_BASE}/personnel`);
                if (response.ok) {
                    allPersonnelData = await response.json();
                    
                    // Fetch skills for each person for qualification filtering
                    const personnelWithSkills = await Promise.all(
                        allPersonnelData.map(async (person) => {
                            try {
                                const skillsResponse = await fetch(`${API_BASE}/personnel/${person.id}/skills`);
                                if (skillsResponse.ok) {
                                    person.skills = await skillsResponse.json();
                                } else {
                                    person.skills = [];
                                }
                            } catch (error) {
                                console.error(`Error loading skills for person ${person.id}:`, error);
                                person.skills = [];
                            }
                            return person;
                        })
                    );
                    
                    allPersonnelData = personnelWithSkills;
                    
                    // Populate department and population dropdowns in column filters
                    populateColumnFilterDropdowns();
                    
                    // Apply current filters and sort
                    applyFiltersAndSort();
                } else {
                    console.error('Error loading personnel:', response.status);
                }
            } catch (error) {
                console.error('Error loading personnel:', error);
            }
        }

        function populateColumnFilterDropdowns() {
            // Populate department dropdown
            const departments = [...new Set(allPersonnelData.map(p => p.department_name).filter(Boolean))].sort();
            const deptSelect = document.getElementById('columnDepartmentFilter');
            if (deptSelect) {
                deptSelect.innerHTML = '<option value="">×›×œ ×”××—×œ×§×•×ª</option>' +
                    departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
            }
            
            // Populate population dropdown
            const populations = [...new Set(allPersonnelData.map(p => p.population_name).filter(Boolean))].sort();
            const popSelect = document.getElementById('columnPopulationFilter');
            if (popSelect) {
                popSelect.innerHTML = '<option value="">×›×œ ×”××•×›×œ×•×¡×™×•×ª</option>' +
                    populations.map(pop => `<option value="${pop}">${pop}</option>`).join('');
            }
        }

        // Debounced global search
        let globalSearchTimeout;
        function debounceGlobalSearch(searchTerm) {
            clearTimeout(globalSearchTimeout);
            globalSearchTimeout = setTimeout(() => {
                performGlobalSearch(searchTerm);
            }, 300);
        }

        function performGlobalSearch(searchTerm) {
            document.getElementById('personnelSearch').value = searchTerm;
            if (searchTerm.trim()) {
                currentFilters['global_search'] = searchTerm.trim();
            } else {
                delete currentFilters['global_search'];
            }
            applyFiltersAndSort();
        }

        // ========== DEPARTMENTS FUNCTIONS ==========
        
        async function showDepartmentModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ××—×œ×§×”' : '×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”';
            
            // Show loading first
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            modal.classList.add('active');
            
            try {
                // Load personnel and departments data
                const [personnelResponse, departmentsResponse] = await Promise.all([
                    fetch(`${API_BASE}/personnel`),
                    fetch(`${API_BASE}/departments`)
                ]);
                
                const personnel = personnelResponse.ok ? await personnelResponse.json() : [];
                const departments = departmentsResponse.ok ? await departmentsResponse.json() : [];
                
                // Filter out commanders and members of other departments for the soldiers list
                const availablePersonnel = personnel.filter(person => !person.is_commander);
                const commanders = personnel.filter(person => !person.is_commander); // All non-commanders can be commanders
                
                modalBody.innerHTML = `
                    <form onsubmit="handleDepartmentSubmit(event, ${editId})" id="departmentForm">
                        <div class="form-group">
                            <label class="form-label">×©× ××—×œ×§×” *</label>
                            <input type="text" class="form-input" name="name" id="departmentName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">××¤×§×“ ××—×œ×§×”</label>
                            <select class="form-input" name="commander_id" id="departmentCommander">
                                <option value="">××™×Ÿ ××¤×§×“ (××•×¤×¦×™×•× ×œ×™)</option>
                                ${commanders.map(person => `
                                    <option value="${person.id}">${person.full_name} - ${person.rank} (${person.personal_number})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">×—×™×™×œ×™×</label>
                            <div id="soldierCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                                ${availablePersonnel.map(person => `
                                    <div style="margin-bottom: 8px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" name="soldiers[]" value="${person.id}" style="margin-left: 8px;">
                                            <span><strong>${person.full_name}</strong> - ${person.rank} (${person.personal_number})</span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <small style="color: var(--text-muted);">××•×¤×¦×™×•× ×œ×™ - × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××—×œ×§×” ×¢× ×©× ×‘×œ×‘×“</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">×”×¢×¨×•×ª</label>
                            <textarea class="form-input" name="notes" id="departmentNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                        </div>
                        
                        <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                            <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ××—×œ×§×”</button>
                        </div>
                    </form>
                `;
                
                // If editing, load existing data
                if (editId) {
                    await loadDepartmentForEdit(editId);
                }
                
            } catch (error) {
                console.error('Error loading department modal data:', error);
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</div>';
            }
        }
        
        async function loadDepartmentForEdit(departmentId) {
            try {
                const response = await fetch(`${API_BASE}/departments/${departmentId}`);
                if (response.ok) {
                    const dept = await response.json();
                    
                    // Fill basic fields
                    document.getElementById('departmentName').value = dept.name;
                    document.getElementById('departmentCommander').value = dept.commander_id || '';
                    document.getElementById('departmentNotes').value = dept.notes || '';
                    
                    // Fetch soldiers separately (like in list view)
                    try {
                        const membersResponse = await fetch(`${API_BASE}/departments/${departmentId}/members`);
                        if (membersResponse.ok) {
                            const members = await membersResponse.json();
                            const soldiers = members.filter(member => !member.is_commander);
                            
                            // Wait a bit for checkboxes to render, then check them
                            setTimeout(() => {
                                if (soldiers && soldiers.length > 0) {
                                    soldiers.forEach(soldier => {
                                        const checkbox = document.querySelector(`#soldierCheckboxes input[value="${soldier.id}"]`);
                                        if (checkbox) {
                                            checkbox.checked = true;
                                        }
                                    });
                                }
                            }, 200);
                        }
                    } catch (memberError) {
                        console.error('Error loading department members for edit:', memberError);
                    }
                }
            } catch (error) {
                console.error('Error loading department for edit:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××—×œ×§×”', 'error');
            }
        }
        
        async function handleDepartmentSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Get selected soldiers
            const selectedSoldiers = Array.from(form.querySelectorAll('input[name="soldiers[]"]:checked')).map(cb => parseInt(cb.value));
            
            const departmentData = {
                name: formData.get('name'),
                commander_id: formData.get('commander_id') ? parseInt(formData.get('commander_id')) : null,
                soldier_ids: selectedSoldiers, // Changed from 'soldiers' to 'soldier_ids' to match server
                notes: formData.get('notes')
            };
            
            try {
                const url = editId ? `${API_BASE}/departments/${editId}` : `${API_BASE}/departments`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(departmentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '××—×œ×§×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '××—×œ×§×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    // Add a small delay before refreshing to ensure server has processed the request
                    setTimeout(() => {
                        loadDepartmentsData();
                    }, 500);
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error saving department:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        
        async function deleteDepartment(id, name) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××—×œ×§×” "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/departments/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('××—×œ×§×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    loadDepartmentsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error deleting department:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        
        async function updateDepartmentsDisplay(departments) {
            const container = document.getElementById('departmentsContainer');
            if (!container) return;
            
            if (departments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">××™×Ÿ ××—×œ×§×•×ª ××•×’×“×¨×•×ª</p>';
                return;
            }
            
            container.innerHTML = departments.map(dept => `
                <div class="department-card">
                    <div class="department-header">
                        <div class="department-name">${dept.name}</div>
                        <div class="department-count">${dept.member_count || 0} ×× ×©×™×</div>
                    </div>
                    <div class="department-details">
                        <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ${dept.commander_name || '×œ× ××•×’×“×¨'}</p>
                        <p><strong>×”×¢×¨×•×ª:</strong> ${dept.notes || '×œ×œ× ×”×¢×¨×•×ª'}</p>
                        ${dept.soldiers && dept.soldiers.length > 0 ? `
                            <div style="margin-top: 12px;">
                                <strong>×—×™×™×œ×™×:</strong>
                                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${dept.soldiers.map(soldier => `
                                        <span style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid var(--border);">
                                            ${soldier.full_name} (${soldier.rank})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="department-actions">
                        <button class="btn btn-secondary" onclick="editDepartment(${dept.id})">×¢×¨×™×›×”</button>
                        <button class="btn btn-danger" onclick="deleteDepartment(${dept.id}, '${dept.name}')">××—×™×§×”</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== POSITIONS & ROLE-HOLDERS FUNCTIONS ==========
        
        let roleHolderCounter = 0;
        
        async function showPositionModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×¢××“×”' : '×”×•×¡×¤×ª ×¢××“×” ×—×“×©×”';
            
            // Reset role holder counter
            roleHolderCounter = 0;
            
            modalBody.innerHTML = `
                <form onsubmit="handlePositionSubmit(event, ${editId})" id="positionForm" data-edit-id="${editId || ''}">
                    <div class="form-group">
                        <label class="form-label">×©× ×¢××“×” *</label>
                        <input type="text" class="form-input" name="name" id="positionName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" id="positionNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª×¤×§×™×“× ×™× * (× ×“×¨×© ×œ×¤×—×•×ª ×ª×¤×§×™×“×Ÿ ××—×“)</label>
                        <div id="roleHoldersContainer" style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; min-height: 100px;">
                            <!-- Role holders will be added dynamically -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="addRoleHolder()">â• ×”×•×¡×£ ×ª×¤×§×™×“×Ÿ</button>
                            <small style="color: var(--text-muted); line-height: 32px;">×›×œ ×ª×¤×§×™×“×Ÿ ×—×™×™×‘ ×©× ×•×›×©×™×¨×•×ª ××—×ª ×œ×¤×—×•×ª</small>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×¢××“×”</button>
                    </div>
                </form>
            `;
            
            modal.classList.add('active');
            
            // Add the first role holder automatically
            await addRoleHolder();
            
            // If editing, load existing position data
            if (editId) {
                await loadPositionForEdit(editId);
            }
        }

        async function handlePositionSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Collect role-holders data
            const roleHolders = [];
            const roleHolderElements = document.querySelectorAll('[data-role-holder]');
            
            for (let i = 0; i < roleHolderElements.length; i++) {
                const element = roleHolderElements[i];
                const index = element.getAttribute('data-role-holder');
                const nameInput = document.querySelector(`input[name="role_${index}_name"]`);
                const qualificationCheckboxes = document.querySelectorAll(`input[name="role_${index}_skills[]"]:checked`);
                
                if (!nameInput || !nameInput.value.trim()) {
                    showToast(`×ª×¤×§×™×“×Ÿ ${i + 1}: ×©× ×”×•× ×©×“×” ×—×•×‘×”`, 'error');
                    return;
                }
                
                if (qualificationCheckboxes.length === 0) {
                    showToast(`×ª×¤×§×™×“×Ÿ "${nameInput.value}": ×—×™×™×‘ ×œ×¤×—×•×ª ×›×©×™×¨×•×ª ××—×ª`, 'error');
                    return;
                }
                
                const qualification_ids = Array.from(qualificationCheckboxes).map(cb => parseInt(cb.value));
                
                roleHolders.push({
                    name: nameInput.value.trim(),
                    qualification_ids: qualification_ids
                });
            }
            
            if (roleHolders.length === 0) {
                showToast('×—×™×™×‘ ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×ª×¤×§×™×“×Ÿ ××—×“', 'error');
                return;
            }
            
            const positionData = {
                name: formData.get('name'),
                notes: formData.get('notes'),
                role_holders: roleHolders
            };

            try {
                const url = editId ? `${API_BASE}/positions/${editId}` : `${API_BASE}/positions`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(positionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(editId ? '×¢××“×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '×¢××“×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadPositionsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢××“×”', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Add role holder to position form
        async function addRoleHolder() {
            const container = document.getElementById('roleHoldersContainer');
            if (!container) return;
            
            const index = roleHolderCounter++;
            
            const roleHolderDiv = document.createElement('div');
            roleHolderDiv.setAttribute('data-role-holder', index);
            roleHolderDiv.style.cssText = 'border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; background: var(--bg-secondary);';
            
            roleHolderDiv.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                    <h4 style="margin: 0; color: var(--text-primary);">×ª×¤×§×™×“×Ÿ ${index + 1}</h4>
                    <button type="button" onclick="removeRoleHolder(${index})" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">×”×¡×¨</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px;">×©× ×ª×¤×§×™×“×Ÿ *</label>
                        <input type="text" name="role_${index}_name" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px;" placeholder="×”×›× ×¡ ×©× ×ª×¤×§×™×“×Ÿ" required>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px;">×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª * (×œ×¤×—×•×ª ××—×ª)</label>
                        <div id="skillsContainer${index}" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 8px;">
                            ×˜×•×¢×Ÿ ×›×©×™×¨×•×™×•×ª...
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(roleHolderDiv);
            await loadSkillsForRoleHolder(index);
        }
        
        // Remove role holder from form
        function removeRoleHolder(index) {
            const roleHolderDiv = document.querySelector(`[data-role-holder="${index}"]`);
            if (roleHolderDiv) {
                roleHolderDiv.remove();
            }
            
            // Prevent removing the last role holder
            const remainingRoleHolders = document.querySelectorAll('[data-role-holder]');
            if (remainingRoleHolders.length === 0) {
                showToast('×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ×ª×¤×§×™×“×Ÿ ××—×“', 'error');
                addRoleHolder();
            }
        }
        
        // Load skills/qualifications for a specific role holder
        async function loadSkillsForRoleHolder(roleHolderIndex) {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                let skills = [];
                
                if (response.ok) {
                    skills = await response.json();
                } else {
                    // Fallback: use hardcoded skills if API doesn't work
                    skills = [
                        {id: 1, name: '×ª×§×©×•×¨×ª'},
                        {id: 2, name: '×¡×™×™×‘×¨'},
                        {id: 3, name: '××‘×˜×—×ª ××™×“×¢'},
                        {id: 4, name: '× ×™×ª×•×— ××•×“×™×¢×™×Ÿ'},
                        {id: 5, name: '××¢×¨×›×•×ª ××—×©×‘'},
                        {id: 6, name: '×œ×•×’×™×¡×˜×™×§×”'},
                        {id: 7, name: '×¨×¤×•××”'},
                        {id: 8, name: '×××œ×´×—'}
                    ];
                }
                
                const container = document.getElementById(`skillsContainer${roleHolderIndex}`);
                if (container) {
                    if (skills.length > 0) {
                        container.innerHTML = skills.map(skill => `
                            <div style="margin-bottom: 4px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="role_${roleHolderIndex}_skills[]" value="${skill.id}" style="margin-left: 8px;">
                                    <span>${skill.name}</span>
                                </label>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div style="color: var(--text-muted);">××™×Ÿ ×›×©×™×¨×•×™×•×ª ×–××™× ×•×ª</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading qualifications:', error);
                const container = document.getElementById(`skillsContainer${roleHolderIndex}`);
                if (container) {
                    container.innerHTML = '<div style="color: var(--danger);">×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª</div>';
                }
            }
        }
        
        // Load position data for editing
        async function loadPositionForEdit(positionId) {
            try {
                // Get position basic info and roles separately
                const [positionResponse, rolesResponse] = await Promise.all([
                    fetch(`${API_BASE}/positions/${positionId}`),
                    fetch(`${API_BASE}/positions/${positionId}/roles`)
                ]);
                
                if (positionResponse.ok) {
                    const position = await positionResponse.json();
                    const roles = rolesResponse.ok ? await rolesResponse.json() : [];
                    
                    // Fill basic form fields
                    document.getElementById('positionName').value = position.name;
                    document.getElementById('positionNotes').value = position.notes || '';
                    
                    // Clear existing role holders and add the ones from the position
                    const container = document.getElementById('roleHoldersContainer');
                    container.innerHTML = '';
                    roleHolderCounter = 0;
                    
                    if (roles && roles.length > 0) {
                        for (const role of roles) {
                            await addRoleHolder();
                            
                            // Fill role holder data
                            const currentIndex = roleHolderCounter - 1;
                            const nameInput = document.querySelector(`input[name="role_${currentIndex}_name"]`);
                            if (nameInput) {
                                nameInput.value = role.name;
                            }
                            
                            // Check the appropriate qualifications
                            if (role.skill_ids) {
                                const skillIds = role.skill_ids.split(',').map(id => parseInt(id.trim()));
                                skillIds.forEach(skillId => {
                                    const checkbox = document.querySelector(`input[name="role_${currentIndex}_skills[]"][value="${skillId}"]`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                    }
                                });
                            }
                        }
                    } else {
                        // No existing role holders, add one empty role holder
                        await addRoleHolder();
                    }
                } else {
                    showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×¢××“×”', 'error');
                }
            } catch (error) {
                console.error('Error loading position for edit:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function loadPositionsData() {
            try {
                const response = await fetch(`${API_BASE}/positions`);
                if (response.ok) {
                    const positions = await response.json();
                    updatePositionsDisplay(positions);
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function updatePositionsDisplay(positions) {
            const container = document.getElementById('positionsContainer');
            if (!container) return;

            if (positions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">××™×Ÿ ×¢××“×•×ª ××•×’×“×¨×•×ª</p>';
                return;
            }

            const positionsWithRoles = await Promise.all(
                positions.map(async position => {
                    const rolesResponse = await fetch(`${API_BASE}/positions/${position.id}/roles`);
                    const roles = rolesResponse.ok ? await rolesResponse.json() : [];
                    return { ...position, roles };
                })
            );

            container.innerHTML = positionsWithRoles.map(position => `
                <div class="position-card">
                    <div class="position-header">
                        <div class="position-name">${position.name}</div>
                        <div class="position-count">${position.role_count || 0} ×ª×¤×§×™×“× ×™×</div>
                    </div>
                    <div class="position-details">
                        <p><strong>×”×¢×¨×•×ª:</strong> ${position.notes || '×œ×œ× ×”×¢×¨×•×ª'}</p>
                    </div>
                    <div class="role-holders">
                        <h4>×ª×¤×§×™×“× ×™×:</h4>
                        <div class="roles-list">
                            ${position.roles.length === 0 ? 
                                '<p style="color: var(--text-muted); text-align: center; padding: 10px;">××™×Ÿ ×ª×¤×§×™×“× ×™× ××•×’×“×¨×™×</p>' :
                                position.roles.map(role => `
                                    <div class="role-item">
                                        <span class="role-name">${role.name}</span>
                                        <span class="role-skills">${role.required_skills || '×œ×œ× ×›×©×™×¨×•×™×•×ª'}</span>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                    <div class="position-actions">
                        <button class="btn btn-secondary" onclick="editPosition(${position.id})">×¢×¨×™×›×”</button>
                        <button class="btn btn-primary" onclick="showRoleModal(${position.id}, '${position.name}')">×”×•×¡×£ ×ª×¤×§×™×“×Ÿ</button>
                        <button class="btn btn-danger" onclick="deletePosition(${position.id})">××—×™×§×”</button>
                    </div>
                </div>
            `).join('');
        }

        async function editPosition(id) {
            // The showPositionModal function with editId will handle loading position data
            showPositionModal(id);
        }

        async function deletePosition(id) {
            try {
                // First get position details to show what will be deleted
                const positionResponse = await fetch(`${API_BASE}/positions/${id}`);
                if (!positionResponse.ok) {
                    showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”×¢××“×”', 'error');
                    return;
                }
                const position = await positionResponse.json();

                // Get role count for position
                const rolesResponse = await fetch(`${API_BASE}/positions/${id}/roles`);
                const roles = rolesResponse.ok ? await rolesResponse.json() : [];

                // Show Hebrew confirmation modal
                const modalContent = `
                    <div style="padding: 24px; text-align: center;">
                        <p style="margin-bottom: 20px; font-size: 16px; color: var(--text-primary);">
                            ××—×™×§×” ×ª×¡×™×¨ ××ª ×”×¢××“×”, ××ª ×”×ª×¤×§×™×“× ×™× ×”××©×•×™×›×™× ×•×›×œ ×©×™×‘×•×¦×™ ×”×©×‘×¦×´×§ ×”×§×©×•×¨×™×. ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ×¤×¢×•×œ×” ×–×•.
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                            <button type="button" class="btn btn-danger" onclick="confirmDeletePosition(${id})">××—×™×§×”</button>
                        </div>
                    </div>
                `;
                
                showModal('×”×× ×œ××—×•×§ ××ª ×”×¢××“×”?', modalContent);
            } catch (error) {
                console.error('Error loading position details:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”×¢××“×”', 'error');
            }
        }

        async function confirmDeletePosition(id) {
            try {
                const response = await fetch(`${API_BASE}/positions/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('×¢××“×” × ××—×§×” ×‘×”×¦×œ×—×” ×¢× ×›×œ ×”×ª×¤×§×™×“× ×™× ×•×”×©×™×‘×•×¦×™×!', 'success');
                    closeModal();
                    loadPositionsData();
                } else {
                    const error = await response.json();
                    showToast(`×©×’×™××” ×‘××—×™×§×ª ×”×¢××“×”: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting position:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function showRoleModal(positionId, positionName, editRoleId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const isEdit = editRoleId !== null;
            modalTitle.textContent = isEdit ? '×¢×¨×™×›×ª ×ª×¤×§×™×“×Ÿ' : `×”×•×¡×¤×ª ×ª×¤×§×™×“×Ÿ - ${positionName}`;
            
            modalBody.innerHTML = `
                <form onsubmit="handleRoleSubmit(event, ${positionId}, ${editRoleId || 'null'})">
                    <div class="form-group">
                        <label class="form-label">×©× ×ª×¤×§×™×“×Ÿ *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª *</label>
                        <div id="skillsMultiSelect" class="skills-multi-select">
                            <div style="text-align: center; padding: 20px;">×˜×•×¢×Ÿ ×›×©×™×¨×•×™×•×ª...</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×ª×¤×§×™×“×Ÿ</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
            
            // Load skills for multi-select
            await loadSkillsForRole(isEdit ? editRoleId : null);
        }

        async function loadSkillsForRole(editRoleId = null) {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                if (response.ok) {
                    const skills = await response.json();
                    
                    // If editing, get current role skills
                    let currentSkills = [];
                    if (editRoleId) {
                        // This would need to be implemented - get current role skills
                        // For now, we'll just show all skills
                    }
                    
                    const container = document.getElementById('skillsMultiSelect');
                    container.innerHTML = skills.map(skill => `
                        <div class="skill-option">
                            <label>
                                <input type="checkbox" name="required_skills" value="${skill.id}" data-skill-name="${skill.name}">
                                ${skill.name}
                                <label style="margin-right: 10px;">
                                    <input type="checkbox" name="skill_${skill.id}_mandatory" ${editRoleId ? '' : 'checked'}>
                                    ×—×•×‘×”
                                </label>
                            </label>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading skills for role:', error);
                document.getElementById('skillsMultiSelect').innerHTML = '<p style="color: var(--text-muted);">×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª</p>';
            }
        }

        async function handleRoleSubmit(event, positionId, editRoleId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const selectedSkills = [];
            const skillCheckboxes = form.querySelectorAll('input[name="required_skills"]:checked');
            
            skillCheckboxes.forEach(checkbox => {
                const skillId = parseInt(checkbox.value);
                const mandatoryCheckbox = form.querySelector(`input[name="skill_${skillId}_mandatory"]`);
                selectedSkills.push({
                    skill_id: skillId,
                    is_mandatory: mandatoryCheckbox ? mandatoryCheckbox.checked : true
                });
            });
            
            if (selectedSkills.length === 0) {
                showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×›×©×™×¨×•×ª ××—×ª', 'error');
                return;
            }
            
            const roleData = {
                name: formData.get('name'),
                notes: formData.get('notes'),
                required_skills: selectedSkills
            };

            try {
                let url, method;
                if (editRoleId && editRoleId !== 'null') {
                    url = `${API_BASE}/positions/${positionId}/roles/${editRoleId}`;
                    method = 'PUT';
                } else {
                    url = `${API_BASE}/positions/${positionId}/roles`;
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roleData)
                });

                if (response.ok) {
                    showToast(editRoleId && editRoleId !== 'null' ? '×ª×¤×§×™×“×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '×ª×¤×§×™×“×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadPositionsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×¤×§×™×“×Ÿ', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function editRole(positionId, roleId) {
            showRoleModal(positionId, '×¢××“×”', roleId);
        }

        async function deleteRole(positionId, roleId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×¤×§×™×“×Ÿ ×–×”?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/positions/${positionId}/roles/${roleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('×ª×¤×§×™×“×Ÿ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
                    loadPositionsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ×ª×¤×§×™×“×Ÿ', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== PERSON SKILLS FUNCTIONS ==========
        
        async function showPersonSkillsModal(personId, personName) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `× ×™×”×•×œ ×›×©×™×¨×•×™×•×ª - ${personName}`;
            modalBody.innerHTML = `
                <div class="person-skills-container">
                    <div class="action-row" style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="showAddPersonSkillForm(${personId})">
                            <span>â•</span>
                            <span>×”×•×¡×£ ×›×©×™×¨×•×ª</span>
                        </button>
                    </div>
                    <div id="personSkillsList">
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading">×˜×•×¢×Ÿ ×›×©×™×¨×•×™×•×ª...</div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">×¡×’×•×¨</button>
                </div>
            `;
            modal.classList.add('active');
            
            // Load person skills
            loadPersonSkills(personId);
        }

        async function loadPersonSkills(personId) {
            try {
                const response = await fetch(`${API_BASE}/personnel/${personId}/skills`);
                if (response.ok) {
                    const skills = await response.json();
                    updatePersonSkillsList(personId, skills);
                } else {
                    document.getElementById('personSkillsList').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª</p>';
                }
            } catch (error) {
                console.error('Error loading person skills:', error);
                document.getElementById('personSkillsList').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª</p>';
            }
        }

        function updatePersonSkillsList(personId, skills) {
            const container = document.getElementById('personSkillsList');
            if (!container) return;

            if (skills.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">×œ× × ××¦××• ×›×©×™×¨×•×™×•×ª</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>×©× ×›×©×™×¨×•×ª</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×ª××¨×™×š ×ª×¤×•×’×”</th>
                            <th>×”×¢×¨×•×ª</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${skills.map(skill => `
                            <tr>
                                <td>${skill.skill_name}</td>
                                <td>
                                    <span class="status-badge ${getStatusClass(skill.status)}">${skill.status}</span>
                                </td>
                                <td>${skill.expiry_date ? new Date(skill.expiry_date).toLocaleDateString('he-IL') : '-'}</td>
                                <td>${skill.notes || '-'}</td>
                                <td>
                                    <button class="btn-icon" onclick="editPersonSkill(${personId}, ${skill.skill_id})" title="×¢×¨×™×›×ª ×›×©×™×¨×•×ª">âœï¸</button>
                                    <button class="btn-icon" onclick="removePersonSkill(${personId}, ${skill.skill_id})" title="×”×¡×¨×ª ×›×©×™×¨×•×ª">ğŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case '××•×¡××š ×›×©×™×¨': return 'status-success';
                case '×‘×ª×”×œ×™×š ×”×¡××›×”': return 'status-warning';
                case '× ×›×©×œ': return 'status-danger';
                case '×¤×’ ×ª×•×§×£': return 'status-muted';
                default: return '';
            }
        }

        async function showAddPersonSkillForm(personId) {
            // Load available skills first
            try {
                const response = await fetch(`${API_BASE}/skills`);
                if (response.ok) {
                    const allSkills = await response.json();
                    const personSkillsResponse = await fetch(`${API_BASE}/personnel/${personId}/skills`);
                    const personSkills = personSkillsResponse.ok ? await personSkillsResponse.json() : [];
                    
                    // Filter out skills already assigned
                    const assignedSkillIds = personSkills.map(ps => ps.skill_id);
                    const availableSkills = allSkills.filter(skill => !assignedSkillIds.includes(skill.id));
                    
                    showPersonSkillForm(personId, null, availableSkills);
                }
            } catch (error) {
                console.error('Error loading skills:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª', 'error');
            }
        }

        function showPersonSkillForm(personId, editSkillId = null, availableSkills = []) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const isEdit = editSkillId !== null;
            modalTitle.textContent = isEdit ? '×¢×¨×™×›×ª ×›×©×™×¨×•×ª ××™×©×™×ª' : '×”×•×¡×¤×ª ×›×©×™×¨×•×ª ×œ××“×';
            
            modalBody.innerHTML = `
                <form onsubmit="handlePersonSkillSubmit(event, ${personId}, ${editSkillId || 'null'})">
                    ${!isEdit ? `
                        <div class="form-group">
                            <label class="form-label">×›×©×™×¨×•×ª *</label>
                            <select class="form-select" name="skill_id" required>
                                <option value="">×‘×—×¨ ×›×©×™×¨×•×ª</option>
                                ${availableSkills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('')}
                            </select>
                        </div>
                    ` : ''}
                    <div class="form-group">
                        <label class="form-label">×¡×˜×˜×•×¡ *</label>
                        <select class="form-select" name="status" required>
                            <option value="">×‘×—×¨ ×¡×˜×˜×•×¡</option>
                            <option value="××•×¡××š ×›×©×™×¨">××•×¡××š ×›×©×™×¨</option>
                            <option value="×‘×ª×”×œ×™×š ×”×¡××›×”">×‘×ª×”×œ×™×š ×”×¡××›×”</option>
                            <option value="× ×›×©×œ">× ×›×©×œ</option>
                            <option value="×¤×’ ×ª×•×§×£">×¤×’ ×ª×•×§×£</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">×ª×—×™×œ×ª ×”×›×©×¨×”</label>
                            <input type="date" class="form-input" name="training_start_date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">×¡×™×•× ×”×›×©×¨×”</label>
                            <input type="date" class="form-input" name="training_end_date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š ×ª×¤×•×’×”</label>
                        <input type="date" class="form-input" name="expiry_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="showPersonSkillsModal(${personId}, '×—×–×¨×”')">×—×–×¨×”</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×›×©×™×¨×•×ª</button>
                    </div>
                </form>
            `;
            
            if (isEdit) {
                // Load current skill data for editing
                loadPersonSkillForEdit(personId, editSkillId);
            }
        }

        async function loadPersonSkillForEdit(personId, skillId) {
            try {
                const response = await fetch(`${API_BASE}/personnel/${personId}/skills`);
                if (response.ok) {
                    const skills = await response.json();
                    const skill = skills.find(s => s.skill_id == skillId);
                    
                    if (skill) {
                        const form = document.querySelector('#genericModal form');
                        if (form) {
                            form.status.value = skill.status || '';
                            form.training_start_date.value = skill.training_start_date || '';
                            form.training_end_date.value = skill.training_end_date || '';
                            form.expiry_date.value = skill.expiry_date || '';
                            form.notes.value = skill.notes || '';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading skill for edit:', error);
            }
        }

        async function handlePersonSkillSubmit(event, personId, skillId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const skillData = {
                skill_id: formData.get('skill_id'),
                status: formData.get('status'),
                training_start_date: formData.get('training_start_date') || null,
                training_end_date: formData.get('training_end_date') || null,
                expiry_date: formData.get('expiry_date') || null,
                notes: formData.get('notes')
            };

            try {
                let url, method;
                if (skillId && skillId !== 'null') {
                    // Update existing skill
                    url = `${API_BASE}/personnel/${personId}/skills/${skillId}`;
                    method = 'PUT';
                    delete skillData.skill_id; // Don't send skill_id for updates
                } else {
                    // Add new skill
                    url = `${API_BASE}/personnel/${personId}/skills`;
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(skillData)
                });

                if (response.ok) {
                    showToast(skillId && skillId !== 'null' ? '×›×©×™×¨×•×ª ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!' : '×›×©×™×¨×•×ª × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
                    // Go back to skills list
                    const personName = document.getElementById('modalTitle').textContent.split(' - ')[1] || '××“×';
                    showPersonSkillsModal(personId, personName);
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        async function editPersonSkill(personId, skillId) {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                if (response.ok) {
                    const allSkills = await response.json();
                    showPersonSkillForm(personId, skillId, allSkills);
                }
            } catch (error) {
                console.error('Error loading skills for edit:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×›×©×™×¨×•×™×•×ª', 'error');
            }
        }

        async function removePersonSkill(personId, skillId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ×›×©×™×¨×•×ª ×–×• ××”××“×?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/personnel/${personId}/skills/${skillId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('×›×©×™×¨×•×ª ×”×•×¡×¨×” ×‘×”×¦×œ×—×”!', 'success');
                    loadPersonSkills(personId); // Reload the skills list
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×”×¡×¨×ª ×›×©×™×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ========== CONSTRAINTS FUNCTIONS ==========
        
        let currentConstraintDepartment = null;
        let currentConstraintWeek = null;
        let departmentMembers = [];
        let weekConstraints = {};
        
        // Constraint types with colors
        const CONSTRAINT_TYPES = {
            vacation: { name: '×—×•×¤×©×”', color: '#22c55e' },
            personal: { name: '××™×©×™', color: '#3b82f6' },
            medical: { name: '×¨×¤×•××™', color: '#ef4444' },
            military: { name: '×¦×‘××™', color: '#f59e0b' },
            reserves: { name: '××™×œ×•××™×', color: '#8b5cf6' },
            course: { name: '×§×•×¨×¡', color: '#ec4899' },
            other: { name: '××—×¨', color: '#6b7280' }
        };
        
        // Initialize constraints page with current week
        function initConstraintsPage() {
            // Set current week (Sunday start)
            const weekPicker = document.getElementById('constraintWeekPicker');
            if (weekPicker) {
                const currentWeek = getCurrentWeekSundayStart();
                weekPicker.value = currentWeek;
            }
            
            // Load departments
            loadDepartmentsForConstraints();
        }
        
        // Get current week in YYYY-Www format (Sunday start)
        function getCurrentWeekSundayStart() {
            const now = new Date();
            
            // Get Sunday of current week
            const sunday = new Date(now);
            sunday.setDate(now.getDate() - now.getDay()); // Sunday is day 0
            
            const year = sunday.getFullYear();
            
            // Calculate week number (Sunday start) - more accurate calculation
            const startOfYear = new Date(year, 0, 1);
            const firstSunday = new Date(startOfYear);
            firstSunday.setDate(1 - startOfYear.getDay()); // Go to first Sunday of year
            if (firstSunday.getFullYear() < year) {
                firstSunday.setDate(firstSunday.getDate() + 7); // Move to first Sunday of current year
            }
            
            const daysSinceFirstSunday = Math.floor((sunday - firstSunday) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.floor(daysSinceFirstSunday / 7) + 1;
            
            return `${year}-W${weekNumber.toString().padStart(2, '0')}`;
        }

        // Convert week picker value (YYYY-Www) to Sunday date (Sunday start)
        function weekPickerToSundayDate(weekPickerValue) {
            const [year, week] = weekPickerValue.split('-W');
            const startOfYear = new Date(year, 0, 1);
            
            // Find the first Sunday of the year
            const firstSunday = new Date(startOfYear);
            firstSunday.setDate(1 - startOfYear.getDay()); // Go back to previous Sunday if needed
            if (firstSunday.getFullYear() < year) {
                firstSunday.setDate(firstSunday.getDate() + 7); // Move to first Sunday of current year
            }
            
            // Calculate the Sunday of the specified week
            const targetSunday = new Date(firstSunday);
            targetSunday.setDate(firstSunday.getDate() + (week - 1) * 7);
            
            return targetSunday;
        }

        // Load departments for constraints selector
        async function loadDepartmentsForConstraints() {
            try {
                const response = await fetch(`${API_BASE}/departments`);
                if (response.ok) {
                    const departments = await response.json();
                    const select = document.getElementById('constraintDepartmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">×‘×—×¨ ××—×œ×§×”</option>' +
                            departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
                    }
                } else {
                    console.error('Failed to load departments for constraints');
                }
            } catch (error) {
                console.error('Error loading departments for constraints:', error);
            }
        }
        
        // Load constraints for selected department
        async function loadConstraintsForDepartment() {
            const departmentId = document.getElementById('constraintDepartmentSelect').value;
            const weekPicker = document.getElementById('constraintWeekPicker');
            
            if (!departmentId) {
                showConstraintsState('×‘×—×¨ ××—×œ×§×” ×›×“×™ ×œ×”×¦×™×’ ××™×œ×•×¦×™× ×¢×‘×•×¨ ×”×©×‘×•×¢ ×”× ×•×›×—×™');
                return;
            }
            
            currentConstraintDepartment = departmentId;
            
            // Always set to current week when selecting department
            const currentWeek = getCurrentWeekSundayStart();
            weekPicker.value = currentWeek;
            currentConstraintWeek = currentWeek;
            
            // Load constraints immediately
            await loadConstraintsData();
        }
        
        // Load constraints for selected week
        async function loadConstraintsForWeek() {
            const departmentId = document.getElementById('constraintDepartmentSelect').value;
            const weekValue = document.getElementById('constraintWeekPicker').value;
            
            if (!weekValue) {
                showConstraintsState('×‘×—×¨ ××—×œ×§×” ×•×©×‘×•×¢ ×›×“×™ ×œ×”×¦×™×’ ××™×œ×•×¦×™×');
                return;
            }
            
            currentConstraintWeek = weekValue;
            
            if (departmentId) {
                await loadConstraintsData();
            } else {
                showConstraintsState('×‘×—×¨ ××—×œ×§×” ×›×“×™ ×œ×”×¦×™×’ ××™×œ×•×¦×™×');
            }
        }
        
        // Show constraints state message
        function showConstraintsState(message, isError = false) {
            const stateDiv = document.getElementById('constraintsState');
            const tableDiv = document.getElementById('constraintsTable');
            
            if (stateDiv) {
                stateDiv.textContent = message;
                stateDiv.style.color = isError ? 'var(--danger)' : 'var(--text-muted)';
                stateDiv.style.display = 'block';
            }
            
            if (tableDiv) {
                tableDiv.style.display = 'none';
            }
        }
        
        // Load constraints data for department and week
        async function loadConstraintsData() {
            if (!currentConstraintDepartment || !currentConstraintWeek) {
                return;
            }
            
            showConstraintsState('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
            
            try {
                // Load department members
                const membersResponse = await fetch(`${API_BASE}/departments/${currentConstraintDepartment}/members`);
                if (!membersResponse.ok) {
                    throw new Error('Failed to load department members');
                }
                departmentMembers = await membersResponse.json();
                
                if (departmentMembers.length === 0) {
                    showConstraintsState('××™×Ÿ ×× ×©×™ ××—×œ×§×” ×œ×ª×¦×•×’×”');
                    return;
                }
                
                // Load constraints for the week
                const weekStart = getWeekStartDate(currentConstraintWeek);
                const constraintsResponse = await fetch(`${API_BASE}/constraints?departmentId=${currentConstraintDepartment}&weekStart=${weekStart}`);
                
                let constraints = [];
                if (constraintsResponse.ok) {
                    constraints = await constraintsResponse.json();
                }
                
                // Build constraints lookup
                weekConstraints = {};
                constraints.forEach(constraint => {
                    const key = `${constraint.person_id}_${constraint.date}`;
                    weekConstraints[key] = constraint;
                });
                
                // Show the table
                displayConstraintsTable();
                
            } catch (error) {
                console.error('Error loading constraints data:', error);
                showConstraintsState('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', true);
            }
        }
        
        // Get week start date (Sunday) from week picker value
        function getWeekStartDate(weekValue) {
            // Use the universal Sunday-start week calculation
            const sunday = weekPickerToSundayDate(weekValue);
            return sunday.toISOString().split('T')[0];
        }
        
        // Display constraints table
        function displayConstraintsTable() {
            const stateDiv = document.getElementById('constraintsState');
            const tableDiv = document.getElementById('constraintsTable');
            const tableBody = document.getElementById('constraintsTableBody');
            const tableHead = document.querySelector('.constraints-grid thead tr');
            const departmentNameSpan = document.getElementById('selectedDepartmentName');
            const weekDisplaySpan = document.getElementById('selectedWeekDisplay');
            
            if (stateDiv) stateDiv.style.display = 'none';
            if (tableDiv) tableDiv.style.display = 'block';
            
            // Update title
            const selectedDepartment = document.getElementById('constraintDepartmentSelect');
            if (departmentNameSpan && selectedDepartment) {
                departmentNameSpan.textContent = selectedDepartment.selectedOptions[0]?.text || '-';
            }
            if (weekDisplaySpan) {
                weekDisplaySpan.textContent = formatWeekDisplay(currentConstraintWeek);
            }
            
            // Generate week dates for headers
            const weekStart = getWeekStartDate(currentConstraintWeek);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                weekDates.push(date);
            }
            
            // Update table headers with day + date
            if (tableHead) {
                tableHead.innerHTML = `
                    <th style="position: sticky; left: 0; background: var(--bg-tertiary); min-width: 160px; max-width: 160px; padding: 12px 8px; border: 1px solid var(--border); font-weight: 600; z-index: 11;">
                        ××™×© ××—×œ×§×”
                    </th>
                    ${weekDates.map(date => `
                        <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">
                            <div>${formatDayHeader(date)}</div>
                            <div style="font-size: 12px; font-weight: 400; color: var(--text-muted); margin-top: 4px;">${formatDateHeader(date)}</div>
                        </th>
                    `).join('')}
                `;
            }
            
            // Generate table rows using the same weekDates array
            if (tableBody) {
                const weekDateStrings = weekDates.map(date => date.toISOString().split('T')[0]);
                
                tableBody.innerHTML = departmentMembers.map(member => {
                    const cells = weekDateStrings.map(date => {
                        const constraintKey = `${member.id}_${date}`;
                        const constraint = weekConstraints[constraintKey];
                        return createConstraintCell(member.id, date, constraint);
                    }).join('');
                    
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); min-width: 160px; max-width: 160px; padding: 8px; font-weight: 500; border: 1px solid var(--border); z-index: 1;">
                                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${member.full_name} (${member.rank})">
                                    ${member.full_name}
                                    <div style="font-size: 12px; color: var(--text-muted);">${member.rank}</div>
                                </div>
                            </td>
                            ${cells}
                        </tr>
                    `;
                }).join('');
            }
        }
        
        // Create constraint cell
        function createConstraintCell(personId, date, constraint) {
            const cellId = `constraint_${personId}_${date}`;
            
            if (constraint) {
                const type = CONSTRAINT_TYPES[constraint.type] || CONSTRAINT_TYPES.other;
                const timeText = constraint.is_full_day ? '×™×•× ××œ×' : `${constraint.start_time}-${constraint.end_time}`;
                
                return `
                    <td style="min-width: 120px; max-width: 120px; padding: 4px; border: 1px solid var(--border); vertical-align: top;">
                        <div class="constraint-item" 
                             style="background: ${type.color}; color: white; padding: 6px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; text-align: center; min-height: 40px; display: flex; flex-direction: column; justify-content: center;"
                             onclick="editConstraint(${personId}, '${date}', ${constraint.id})"
                             title="${type.name} - ${timeText}">
                            <div style="font-weight: 500;">${type.name}</div>
                            <div style="font-size: 9px; margin-top: 2px; opacity: 0.9;">${timeText}</div>
                        </div>
                    </td>
                `;
            } else {
                return `
                    <td style="min-width: 120px; max-width: 120px; padding: 4px; border: 1px solid var(--border); vertical-align: top;">
                        <div class="constraint-add" 
                             style="border: 1px dashed var(--border); padding: 8px; border-radius: 6px; text-align: center; cursor: pointer; color: var(--text-muted); font-size: 12px; min-height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
                             onclick="addConstraint(${personId}, '${date}')"
                             onmouseover="this.style.backgroundColor='var(--bg-secondary)'; this.style.borderColor='var(--primary)'"
                             onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='var(--border)'"
                             title="×”×•×¡×£ ××™×œ×•×¥">
                            â•
                        </div>
                    </td>
                `;
            }
        }
        
        // Format week display
        function formatWeekDisplay(weekValue) {
            if (!weekValue) return '-';
            const [year, week] = weekValue.split('-W');
            return `×©×‘×•×¢ ${week}, ${year}`;
        }
        
        // Format day name for header (Hebrew)
        function formatDayHeader(date) {
            const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            return dayNames[date.getDay()];
        }
        
        // Format date for header (day.month.year)
        function formatDateHeader(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // Add constraint
        function addConstraint(personId, date) {
            console.log('Add constraint for person', personId, 'on', date);
            showConstraintModal(personId, date);
        }
        
        // Edit constraint
        function editConstraint(personId, date, constraintId) {
            console.log('Edit constraint', constraintId, 'for person', personId, 'on', date);
            showConstraintModal(personId, date, constraintId);
        }
        
        // Show constraint modal
        async function showConstraintModal(personId, date, constraintId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            // Find person name
            const person = departmentMembers.find(m => m.id === personId);
            const personName = person ? `${person.full_name} (${person.rank})` : '×œ× ×™×“×•×¢';
            
            modalTitle.textContent = constraintId ? '×¢×¨×™×›×ª ××™×œ×•×¥' : '×”×•×¡×¤×ª ××™×œ×•×¥';
            
            // Get existing constraint data if editing
            let existingConstraint = null;
            if (constraintId) {
                const constraintKey = `${personId}_${date}`;
                existingConstraint = weekConstraints[constraintKey];
            }
            
            modalBody.innerHTML = `
                <form onsubmit="handleConstraintSubmit(event)" data-person-id="${personId}" data-date="${date}" data-constraint-id="${constraintId || ''}">
                    <div class="form-group">
                        <label class="form-label">××™×© ××—×œ×§×”</label>
                        <input type="text" class="form-input" value="${personName}" readonly style="background: var(--bg-tertiary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š</label>
                        <input type="text" class="form-input" value="${formatDateDisplay(date)}" readonly style="background: var(--bg-tertiary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ××™×œ×•×¥ *</label>
                        <select class="form-select" name="type" required>
                            <option value="">×‘×—×¨ ×¡×•×’ ××™×œ×•×¥</option>
                            ${Object.entries(CONSTRAINT_TYPES).map(([key, type]) => 
                                `<option value="${key}" ${existingConstraint?.type === key ? 'selected' : ''}>${type.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="is_full_day" ${existingConstraint?.is_full_day ? 'checked' : ''} onchange="toggleTimeFields(this)">
                            ×™×•× ××œ×
                        </label>
                    </div>
                    <div id="timeFields" style="display: ${existingConstraint?.is_full_day ? 'none' : 'block'};">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label class="form-label">×©×¢×ª ×”×ª×—×œ×” *</label>
                                <input type="time" class="form-input" name="start_time" value="${existingConstraint?.start_time || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">×©×¢×ª ×¡×™×•× *</label>
                                <input type="time" class="form-input" name="end_time" value="${existingConstraint?.end_time || ''}" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª×™××•×¨</label>
                        <textarea class="form-input" name="description" rows="3" placeholder="×ª×™××•×¨ × ×•×¡×£...">${existingConstraint?.description || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        ${constraintId ? `<button type="button" class="btn btn-danger" onclick="deleteConstraint(${constraintId})">××—×™×§×”</button>` : ''}
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${constraintId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ××™×œ×•×¥</button>
                    </div>
                </form>
            `;
            
            modal.classList.add('active');
        }
        
        // Toggle time fields based on full day checkbox
        function toggleTimeFields(checkbox) {
            const timeFields = document.getElementById('timeFields');
            const startTimeInput = document.querySelector('input[name="start_time"]');
            const endTimeInput = document.querySelector('input[name="end_time"]');
            
            if (checkbox.checked) {
                timeFields.style.display = 'none';
                startTimeInput.required = false;
                endTimeInput.required = false;
            } else {
                timeFields.style.display = 'block';
                startTimeInput.required = true;
                endTimeInput.required = true;
            }
        }
        
        // Format date for display
        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr);
            const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            const dayName = days[date.getDay()];
            const dateFormatted = date.toLocaleDateString('he-IL');
            return `${dayName}, ${dateFormatted}`;
        }
        
        // Handle constraint form submission
        async function handleConstraintSubmit(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const formData = new FormData(form);
            
            const personId = parseInt(form.getAttribute('data-person-id'));
            const date = form.getAttribute('data-date');
            const constraintId = form.getAttribute('data-constraint-id');
            
            const isFullDay = formData.get('is_full_day') === 'on';
            const startTime = formData.get('start_time');
            const endTime = formData.get('end_time');
            
            // Validate time range if not full day
            if (!isFullDay) {
                if (!startTime || !endTime) {
                    showToast('×™×© ×œ×”×–×™×Ÿ ×©×¢×ª ×”×ª×—×œ×” ×•×¡×™×•×', 'error');
                    return;
                }
                if (startTime >= endTime) {
                    showToast('×©×¢×ª ×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×', 'error');
                    return;
                }
            }
            
            const constraintData = {
                person_id: personId,
                date: date,
                type: formData.get('type'),
                is_full_day: isFullDay ? 1 : 0,
                start_time: isFullDay ? null : startTime,
                end_time: isFullDay ? null : endTime,
                description: formData.get('description') || null
            };
            
            try {
                const url = constraintId ? `${API_BASE}/constraints/${constraintId}` : `${API_BASE}/constraints`;
                const method = constraintId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(constraintData)
                });
                
                if (response.ok) {
                    showToast(constraintId ? '××™×œ×•×¥ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '××™×œ×•×¥ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    await loadConstraintsData(); // Reload the table
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×©××™×¨×ª ××™×œ×•×¥', 'error');
                }
            } catch (error) {
                console.error('Error saving constraint:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Delete constraint
        async function deleteConstraint(constraintId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××™×œ×•×¥ ×–×”?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/constraints/${constraintId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('××™×œ×•×¥ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    await loadConstraintsData(); // Reload the table
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ××™×œ×•×¥', 'error');
                }
            } catch (error) {
                console.error('Error deleting constraint:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // Placeholder functions
        function exportPersonnel() {
            // Get the currently filtered and sorted data
            let dataToExport = [...allPersonnelData];

            // Apply all current filters
            Object.keys(currentFilters).forEach(column => {
                const filterValue = currentFilters[column].toLowerCase();
                dataToExport = dataToExport.filter(person => {
                    let cellValue = '';
                    
                    switch (column) {
                        case 'full_name':
                            cellValue = person.full_name || '';
                            break;
                        case 'personal_number':
                            cellValue = person.personal_number || '';
                            break;
                        case 'rank':
                            cellValue = person.rank || '';
                            break;
                        case 'branch':
                            cellValue = person.branch || '';
                            break;
                        case 'department_name':
                            cellValue = person.department_name || '';
                            break;
                        case 'population_name':
                            cellValue = person.population_name || '';
                            break;
                        case 'residence':
                            cellValue = person.residence || '';
                            break;
                        case 'arrival_date':
                            cellValue = person.arrival_date || person.enlistment_date || '';
                            return cellValue.includes(filterValue);
                        case 'marital_status':
                            cellValue = person.marital_status || '';
                            break;
                        case 'global_search':
                            const searchFields = [
                                person.full_name,
                                person.personal_number,
                                person.rank,
                                person.branch,
                                person.department_name,
                                person.population_name,
                                person.residence
                            ].filter(Boolean).join(' ');
                            return searchFields.toLowerCase().includes(filterValue);
                        case 'qualification_filter':
                            return person.skills && person.skills.some(skill => skill.skill_id == filterValue);
                        default:
                            return true;
                    }
                    
                    return cellValue.toLowerCase().includes(filterValue);
                });
            });

            // Apply current sorting
            if (currentSort.column) {
                dataToExport.sort((a, b) => {
                    let aVal = '', bVal = '';
                    
                    switch (currentSort.column) {
                        case 'full_name':
                            aVal = a.full_name || '';
                            bVal = b.full_name || '';
                            break;
                        case 'personal_number':
                            aVal = a.personal_number || '';
                            bVal = b.personal_number || '';
                            break;
                        case 'rank':
                            aVal = a.rank || '';
                            bVal = b.rank || '';
                            break;
                        case 'branch':
                            aVal = a.branch || '';
                            bVal = b.branch || '';
                            break;
                        case 'department_name':
                            aVal = a.department_name || '';
                            bVal = b.department_name || '';
                            break;
                        case 'population_name':
                            aVal = a.population_name || '';
                            bVal = b.population_name || '';
                            break;
                        case 'residence':
                            aVal = a.residence || '';
                            bVal = b.residence || '';
                            break;
                        case 'arrival_date':
                            aVal = a.arrival_date || a.enlistment_date || '';
                            bVal = b.arrival_date || b.enlistment_date || '';
                            break;
                        case 'marital_status':
                            aVal = a.marital_status || '';
                            bVal = b.marital_status || '';
                            break;
                        default:
                            return 0;
                    }
                    
                    if (currentSort.column === 'arrival_date') {
                        aVal = new Date(aVal || '1900-01-01');
                        bVal = new Date(bVal || '1900-01-01');
                    } else if (currentSort.column === 'full_name') {
                        const comparison = aVal.localeCompare(bVal, 'he', { numeric: true, sensitivity: 'base' });
                        return currentSort.direction === 'asc' ? comparison : -comparison;
                    }
                    
                    const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    return currentSort.direction === 'asc' ? comparison : -comparison;
                });
            }

            // Prepare data for Excel export
            const excelData = dataToExport.map(person => ({
                '×©× ××œ×': person.full_name || '',
                '××¡×¤×¨ ××™×©×™': person.personal_number || '',
                '×“×¨×’×”': person.rank || '',
                '×’×£': person.branch || '',
                '××—×œ×§×”': person.department_name || '×œ× ××©×•×‘×¥',
                '××•×›×œ×•×¡×™×™×”': person.population_name || '×œ× ××•×’×“×¨',
                '××§×•× ××’×•×¨×™×': person.residence || '',
                '×ª××¨×™×š ×”×’×¢×”': person.arrival_date || person.enlistment_date || '',
                '×¡×˜×˜×•×¡ ××©×¤×—×ª×™': person.marital_status || '',
                '×ª×¢×•×“×ª ×–×”×•×ª': person.id_number || '',
                '×ª××¨×™×š ×œ×™×“×”': person.birth_date || '',
                '×ª××¨×™×š ×’×™×•×¡': person.enlistment_date || '',
                '×ª××¨×™×š ×©×—×¨×•×¨': person.discharge_date || '',
                '××¡×¤×¨ ×˜×œ×¤×•×Ÿ': person.phone || '',
                '××—×–×•×¨ ×§×•×¨×¡': person.course_cycle || '',
                '×”×¢×¨×•×ª': person.notes || ''
            }));

            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Set column widths
            const colWidths = [
                { wch: 20 }, // ×©× ××œ×
                { wch: 12 }, // ××¡×¤×¨ ××™×©×™
                { wch: 8 },  // ×“×¨×’×”
                { wch: 12 }, // ×’×£
                { wch: 15 }, // ××—×œ×§×”
                { wch: 12 }, // ××•×›×œ×•×¡×™×™×”
                { wch: 15 }, // ××§×•× ××’×•×¨×™×
                { wch: 12 }, // ×ª××¨×™×š ×”×’×¢×”
                { wch: 12 }, // ×¡×˜×˜×•×¡ ××©×¤×—×ª×™
                { wch: 12 }, // ×ª×¢×•×“×ª ×–×”×•×ª
                { wch: 12 }, // ×ª××¨×™×š ×œ×™×“×”
                { wch: 12 }, // ×ª××¨×™×š ×’×™×•×¡
                { wch: 12 }, // ×ª××¨×™×š ×©×—×¨×•×¨
                { wch: 12 }, // ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
                { wch: 12 }, // ××—×–×•×¨ ×§×•×¨×¡
                { wch: 20 }  // ×”×¢×¨×•×ª
            ];
            ws['!cols'] = colWidths;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "×ª×™×§×™× ××™×©×™×™×");

            // Generate filename with current date and filter info
            const currentDate = new Date().toISOString().split('T')[0];
            let filename = `×ª×™×§×™×_××™×©×™×™×_${currentDate}`;
            
            // Add filter info to filename if filters are active
            const filterCount = Object.keys(currentFilters).length;
            if (filterCount > 0) {
                filename += `_××¡×•× ×Ÿ`;
            }
            
            filename += '.xlsx';

            // Export file
            XLSX.writeFile(wb, filename);
            
            showToast(`×™×¦×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”! ${dataToExport.length} ×¨×©×•××•×ª`, 'success');
        }
        function showQuickAdd() { console.log('Quick add'); }

        
        // Filter soldiers in department modal
        function filterSoldiers(searchValue) {
            const searchTerm = searchValue.toLowerCase().trim();
            const soldierOptions = document.querySelectorAll('.soldier-option');
            
            soldierOptions.forEach(option => {
                const name = option.dataset.name || '';
                const rank = option.dataset.rank || '';
                
                if (name.includes(searchTerm) || rank.includes(searchTerm)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Delete department with confirmation
        async function deleteDepartment(departmentId, departmentName) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××—×œ×§×” "${departmentName}"?\n\n×”×—×™×™×œ×™× ×‘××—×œ×§×” ×™×•×¢×‘×¨×• ×œ××¦×‘ ×œ× ××©×•×™×š.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/departments/${departmentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('××—×œ×§×” × ××—×§×” ×‘×”×¦×œ×—×”', 'success');
                    loadDepartmentsData();
                } else {
                    showToast(result.error || '×©×’×™××” ×‘××—×™×§×ª ×”××—×œ×§×”', 'error');
                }
            } catch (error) {
                console.error('Error deleting department:', error);
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”××—×œ×§×”', 'error');
            }
        }

        // Load departments data
        async function loadDepartmentsData() {
            try {
                const response = await fetch(`${API_BASE}/departments`);
                if (response.ok) {
                    const departments = await response.json();
                    await updateDepartmentsDisplay(departments);
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Update departments display
        async function updateDepartmentsDisplay(departments) {
            const container = document.getElementById('departmentsContainer');
            if (!container) return;

            if (departments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">××™×Ÿ ××—×œ×§×•×ª ××•×’×“×¨×•×ª</p>';
                return;
            }

            // Load members for each department
            const departmentsWithMembers = await Promise.all(
                departments.map(async (dept) => {
                    try {
                        const response = await fetch(`${API_BASE}/departments/${dept.id}/members`);
                        const members = response.ok ? await response.json() : [];
                        return { ...dept, members };
                    } catch (error) {
                        console.error(`Error loading members for department ${dept.id}:`, error);
                        return { ...dept, members: [] };
                    }
                })
            );

            container.innerHTML = departmentsWithMembers.map(dept => {
                const commander = dept.members.find(m => m.is_commander);
                const soldiers = dept.members.filter(m => !m.is_commander);
                
                return `
                    <div class="department-card">
                        <div class="department-header">
                            <div class="department-name">${dept.name}</div>
                            <div class="department-count">${dept.members.length} ×× ×©×™×</div>
                        </div>
                        <div class="department-details">
                            <p><strong>××¤×§×“ ××—×œ×§×”:</strong> ${commander ? `${commander.full_name} - ${commander.rank}` : '×œ× ××•×’×“×¨'}</p>
                            ${soldiers.length > 0 ? `
                                <p><strong>×—×™×™×œ×™×:</strong></p>
                                <div class="soldiers-list" style="margin-right: 12px;">
                                    ${soldiers.map(soldier => 
                                        `<span class="soldier-chip" style="display: inline-block; background: var(--bg-tertiary); padding: 4px 8px; margin: 2px; border-radius: 12px; font-size: 12px; color: var(--text-secondary);">
                                            ${soldier.full_name} - ${soldier.rank}
                                        </span>`
                                    ).join('')}
                                </div>
                            ` : '<p style="color: var(--text-muted); font-style: italic;">××™×Ÿ ×—×™×™×œ×™× ×‘××—×œ×§×”</p>'}
                            ${dept.notes ? `<p><strong>×”×¢×¨×•×ª:</strong> ${dept.notes}</p>` : ''}
                        </div>
                        <div class="department-actions">
                            <button class="btn btn-secondary" onclick="editDepartment(${dept.id})">×¢×¨×™×›×”</button>
                            <button class="btn btn-danger" onclick="deleteDepartment(${dept.id}, '${dept.name}')">××—×™×§×”</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show department modal for create/edit
        async function showDepartmentModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const isEdit = editId !== null;
            modalTitle.textContent = isEdit ? '×¢×¨×™×›×ª ××—×œ×§×”' : '×”×•×¡×¤×ª ××—×œ×§×” ×—×“×©×”';
            
            modalBody.innerHTML = `
                <form onsubmit="handleDepartmentSubmit(event, ${editId || 'null'})">
                    <div class="form-group">
                        <label class="form-label">×©× ××—×œ×§×” *</label>
                        <input type="text" class="form-input" id="departmentName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">××¤×§×“ ××—×œ×§×”</label>
                        <select class="form-select" id="commanderSelect" name="commander_id">
                            <option value="">×‘×—×¨ ××¤×§×“ (××•×¤×¦×™×•× ×œ×™)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×—×™×™×œ×™×</label>
                        <div style="margin-bottom: 8px;">
                            <input type="text" placeholder="×—×™×¤×•×© ×—×™×™×œ×™×..." class="form-input" 
                                   style="margin-bottom: 8px;" oninput="filterSoldiers(this.value)">
                        </div>
                        <div id="soldiersMultiSelect" class="soldiers-multi-select" 
                             style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px;">
                            <div style="text-align: center; padding: 20px;">×˜×•×¢×Ÿ ×¨×©×™××ª ×—×™×™×œ×™×...</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×”×¢×¨×•×ª</label>
                        <textarea class="form-input" id="departmentNotes" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ××—×œ×§×”</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
            
            // Load personnel for selection
            await loadPersonnelForDepartment(editId);
        }

        // Edit department
        function editDepartment(departmentId) {
            showDepartmentModal(departmentId);
        }

        // Load personnel for department selection
        async function loadPersonnelForDepartment(editDepartmentId = null) {
            try {
                // Get all personnel and current department members
                const [personnelResponse, membersResponse] = await Promise.all([
                    fetch(`${API_BASE}/personnel`),
                    editDepartmentId ? fetch(`${API_BASE}/departments/${editDepartmentId}/members`) : Promise.resolve({ ok: false })
                ]);

                const allPersonnel = personnelResponse.ok ? await personnelResponse.json() : [];
                const currentMembers = membersResponse.ok ? await membersResponse.json() : [];
                
                const commanderSelect = document.getElementById('commanderSelect');
                const soldiersContainer = document.getElementById('soldiersMultiSelect');
                
                if (!commanderSelect || !soldiersContainer) return;

                // Populate commander dropdown
                commanderSelect.innerHTML = '<option value="">×‘×—×¨ ××¤×§×“ (××•×¤×¦×™×•× ×œ×™)</option>' + 
                    allPersonnel.map(person => `<option value="${person.id}">${person.full_name} - ${person.rank}</option>`).join('');

                // Populate soldiers multi-select with ALL personnel
                soldiersContainer.innerHTML = allPersonnel.map(person => {
                    const isCurrentMember = currentMembers.some(member => member.id === person.id);
                    const isCommander = currentMembers.some(member => member.id === person.id && member.is_commander);
                    
                    return `
                        <div class="soldier-option" data-name="${person.full_name.toLowerCase()}" data-rank="${person.rank.toLowerCase()}" 
                             style="padding: 8px; margin: 4px 0; border-radius: 4px; background: ${isCurrentMember ? 'var(--bg-tertiary)' : 'transparent'}; border: 1px solid ${isCurrentMember ? 'var(--primary)' : 'var(--border)'};">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="soldier_ids" value="${person.id}" 
                                       ${isCurrentMember ? 'checked' : ''} style="margin-left: 8px;">
                                <div>
                                    <strong>${person.full_name}</strong> - ${person.rank}
                                    <br><small style="color: var(--text-muted);">${person.personal_number} | ${person.department_name || '×œ× ××©×•×‘×¥'}</small>
                                    ${isCommander ? '<br><span style="color: var(--primary); font-weight: bold;">××¤×§×“ × ×•×›×—×™</span>' : ''}
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');

                // If editing, load current department data
                if (editDepartmentId) {
                    const deptResponse = await fetch(`${API_BASE}/departments/${editDepartmentId}`);
                    if (deptResponse.ok) {
                        const dept = await deptResponse.json();
                        document.getElementById('departmentName').value = dept.name || '';
                        document.getElementById('departmentNotes').value = dept.notes || '';
                        if (dept.commander_id) {
                            commanderSelect.value = dept.commander_id;
                        }
                    }
                }

            } catch (error) {
                console.error('Error loading personnel for department:', error);
                document.getElementById('soldiersMultiSelect').innerHTML = '<p style="color: var(--text-muted);">×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×—×™×™×œ×™×</p>';
            }
        }

        // Handle department form submission
        async function handleDepartmentSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const departmentData = {
                name: formData.get('name'),
                commander_id: formData.get('commander_id') || null,
                notes: formData.get('notes') || '',
                soldier_ids: [] // Will be populated below
            };

            // Get selected soldiers
            const soldierCheckboxes = form.querySelectorAll('input[name="soldier_ids"]:checked');
            departmentData.soldier_ids = Array.from(soldierCheckboxes).map(cb => parseInt(cb.value));

            try {
                const url = editId ? `${API_BASE}/departments/${editId}` : `${API_BASE}/departments`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(departmentData)
                });
                
                if (response.ok) {
                    showToast(`××—×œ×§×” ${editId ? '×¢×•×“×›× ×”' : '× ×•×¡×¤×”'} ×‘×”×¦×œ×—×”!`, 'success');
                    closeModal();
                    loadDepartmentsData();
                } else {
                    const error = await response.json();
                    showToast(error.error || `×©×’×™××” ×‘${editId ? '×¢×“×›×•×Ÿ' : '×”×•×¡×¤×ª'} ×”××—×œ×§×”`, 'error');
                }
            } catch (error) {
                console.error('Error saving department:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }


        // Delete role with confirmation
        async function deleteRole(positionId, roleId, roleName = '×”×ª×¤×§×™×“×Ÿ') {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×¤×§×™×“×Ÿ "${roleName}"?\n\n××—×™×§×” ×–×• ×ª××—×§ ×’× ××ª ×›×œ ×”×›×©×™×¨×•×™×•×ª ×”× ×“×¨×©×•×ª ×œ×ª×¤×§×™×“×Ÿ.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/positions/${positionId}/roles/${roleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('×”×ª×¤×§×™×“×Ÿ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                    // loadPositionsData(); // Uncomment when API is ready
                } else {
                    const result = await response.json();
                    showToast(result.error || '×©×’×™××” ×‘××—×™×§×ª ×”×ª×¤×§×™×“×Ÿ', 'error');
                }
            } catch (error) {
                console.error('Error deleting role:', error);
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”×ª×¤×§×™×“×Ÿ', 'error');
            }
        }

        // Generic table filter function
        function filterTable(searchValue, tableId, searchColumnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            const searchTerm = searchValue.toLowerCase().trim();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const cellText = cells[searchColumnIndex].textContent.toLowerCase();
                    if (cellText.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded - JavaScript is working!');
            console.log('Window location:', window.location.href);
            console.log('Document ready state:', document.readyState);
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.dataset.theme = savedTheme;
                const themeBtn = document.querySelector('.theme-toggle-btn');
                if (themeBtn) {
                    themeBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                }
            }

            // Initialize navigation
            console.log('Initializing navigation...');
            
            // Test if navigation elements exist
            const navItems = document.querySelectorAll('.nav-item');
            console.log('Navigation debug: Found', navItems.length, 'nav items');
            
            navItems.forEach((item, index) => {
                console.log(`Nav item ${index}:`, item.getAttribute('data-section'), item.textContent.trim());
            });
            
            initNavigation();
            
            // Add a test button for debugging
            document.body.addEventListener('click', (e) => {
                console.log('Click detected on:', e.target.tagName, e.target.className, e.target);
            });

            // Close modal when clicking outside
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        closeModal();
                    }
                });
            }

            // Setup search functionality
            const personnelSearch = document.getElementById('personnelSearch');
            if (personnelSearch) {
                personnelSearch.addEventListener('input', (e) => {
                    debounceSearch(e.target.value);
                });
            }

            const populationSearch = document.getElementById('populationSearch');
            if (populationSearch) {
                populationSearch.addEventListener('input', (e) => {
                    filterTable(e.target.value, 'populationsTable', 0);
                });
            }

            const skillSearch = document.getElementById('skillSearch');
            if (skillSearch) {
                skillSearch.addEventListener('input', (e) => {
                    filterTable(e.target.value, 'skillsTable', 0);
                });
            }

            // Load initial data
            console.log('Loading personnel data...');
            loadPersonnelData();
            console.log('Loading populations data...');
            loadPopulationsData();
            console.log('Loading departments data...');
            loadDepartmentsData();
            console.log('Loading skills data...');
            loadSkillsData();
            console.log('Loading positions data...');
            loadPositionsData();
            console.log('Loading departments for constraints...');
            loadDepartmentsForConstraints();

        });
        
        // ========== SCHEDULE FUNCTIONS ==========
        
        let currentScheduleData = null;
        
        // Load positions for schedule selector
        async function loadPositionsForSchedule() {
            try {
                const response = await fetch(`${API_BASE}/positions`);
                if (response.ok) {
                    const positions = await response.json();
                    const select = document.getElementById('schedulePositionSelect');
                    if (select) {
                        select.innerHTML = '<option value="">×‘×—×¨ ×¢××“×”</option>' + 
                            positions.map(pos => `<option value="${pos.id}">${pos.name}</option>`).join('');
                    }
                }
                
                // Initialize week picker to current week (Sunday start)
                const weekPicker = document.getElementById('scheduleWeekPicker');
                if (weekPicker) {
                    const currentWeek = getCurrentWeekSundayStart();
                    weekPicker.value = currentWeek;
                }
            } catch (error) {
                console.error('Error loading positions for schedule:', error);
            }
        }
        
        // Load schedule data for selected position and week
        async function loadScheduleData() {
            const positionSelect = document.getElementById('schedulePositionSelect');
            const weekPicker = document.getElementById('scheduleWeekPicker');
            const addTimeRangeBtn = document.getElementById('addTimeRangeBtn');
            
            if (!positionSelect?.value || !weekPicker?.value) {
                showScheduleState('empty');
                if (addTimeRangeBtn) addTimeRangeBtn.disabled = true;
                return;
            }
            
            const positionId = positionSelect.value;
            const weekStart = weekPicker.value;
            
            // Convert week picker format to Sunday date (Sunday start)
            const israelWeekStart = weekPickerToSundayDate(weekStart);
            const dateString = israelWeekStart.toISOString().split('T')[0];
            
            showScheduleState('loading');
            
            try {
                const response = await fetch(`${API_BASE}/schedule?positionId=${positionId}&weekStart=${dateString}`);
                if (response.ok) {
                    currentScheduleData = await response.json();
                    renderScheduleGrid();
                    if (addTimeRangeBtn) addTimeRangeBtn.disabled = false;
                } else {
                    showScheduleState('error');
                    if (addTimeRangeBtn) addTimeRangeBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error loading schedule data:', error);
                showScheduleState('error');
                if (addTimeRangeBtn) addTimeRangeBtn.disabled = true;
            }
        }
        
        // Render the schedule grid with time ranges and role holders
        function renderScheduleGrid() {
            if (!currentScheduleData) return;
            
            const { timeRanges, roleHolders, assignments, notes } = currentScheduleData;
            
            // Ensure at least one time range (default 08:00-14:00)
            if (timeRanges.length === 0) {
                const positionSelect = document.getElementById('schedulePositionSelect');
                const weekPicker = document.getElementById('scheduleWeekPicker');
                createDefaultTimeRange(positionSelect.value, weekPicker.value);
                return;
            }
            
            // Show time ranges header
            renderTimeRangesHeader(timeRanges);
            
            // Show schedule table
            renderScheduleTable(timeRanges, roleHolders, assignments);
            
            // Show notes section
            renderNotesSection(notes);
            
            showScheduleState('table');
        }
        
        // Render time ranges header with chips
        function renderTimeRangesHeader(timeRanges) {
            const headerContainer = document.getElementById('timeRangesHeader');
            const chipsContainer = document.getElementById('timeRangeChips');
            
            if (!headerContainer || !chipsContainer) return;
            
            chipsContainer.innerHTML = timeRanges.map(range => `
                <div class="time-range-chip" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 16px; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>${range.start.slice(0,5)} - ${range.end.slice(0,5)}</span>
                    <button onclick="editTimeRange(${range.id})" style="background: none; border: none; color: white; cursor: pointer; padding: 0;">âœï¸</button>
                    <button onclick="deleteTimeRange(${range.id})" style="background: none; border: none; color: white; cursor: pointer; padding: 0;" ${timeRanges.length <= 1 ? 'disabled title="×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ×˜×•×•×— ×©×¢×•×ª ××—×“"' : ''}>ğŸ—‘ï¸</button>
                </div>
            `).join('');
            
            headerContainer.style.display = 'block';
        }
        
        // Render schedule table with role holders x days x time ranges
        function renderScheduleTable(timeRanges, roleHolders, assignments) {
            const tableHead = document.getElementById('scheduleTableHead');
            const tableBody = document.getElementById('scheduleTableBody');
            const tableContainer = document.getElementById('scheduleTableContainer');
            
            if (!tableHead || !tableBody || !tableContainer) return;
            
            // Days of week (Sunday to Saturday)
            const daysHeb = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            
            // Build header
            let headerHTML = `
                <tr>
                    <th style="position: sticky; left: 0; background: var(--bg-tertiary); min-width: 150px; padding: 12px 8px; border: 1px solid var(--border); font-weight: 600; z-index: 11;">
                        ×ª×¤×§×™×“×Ÿ
                    </th>
            `;
            
            // Add headers for each day
            daysHeb.forEach(day => {
                headerHTML += `
                    <th style="min-width: 120px; padding: 12px 8px; border: 1px solid var(--border); text-align: center; font-weight: 600;">
                        ${day}
                    </th>
                `;
            });
            
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;
            
            // Build body rows
            let bodyHTML = '';
            
            roleHolders.forEach(roleHolder => {
                timeRanges.forEach(timeRange => {
                    bodyHTML += `
                        <tr style="background: ${roleHolders.indexOf(roleHolder) % 2 === 0 ? 'var(--bg-primary)' : 'var(--bg-secondary)'};">
                            <td style="position: sticky; left: 0; background: inherit; min-width: 150px; max-width: 150px; padding: 8px; border: 1px solid var(--border); font-weight: 500; z-index: 1;">
                                <div style="font-size: 14px;">${roleHolder.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${timeRange.start.slice(0,5)}-${timeRange.end.slice(0,5)}</div>
                            </td>
                    `;
                    
                    // Add cells for each day
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const assignment = assignments.find(a => 
                            a.role_id === roleHolder.id && 
                            a.day_of_week === dayIndex && 
                            a.time_block_id === timeRange.id
                        );
                        
                        if (assignment) {
                            console.log('=== ASSIGNMENT FOUND ===');
                            console.log('Display Assignment:', {
                                assignment,
                                roleHolderId: roleHolder.id,
                                dayIndex,
                                timeBlockId: timeRange.id,
                                cellPosition: `Role: ${roleHolder.name}, Day: ${dayIndex}, Time: ${timeRange.start}-${timeRange.end}`
                            });
                        }
                        
                        bodyHTML += `
                            <td style="min-width: 120px; padding: 4px; border: 1px solid var(--border); text-align: center; vertical-align: middle;">
                                <div class="assignment-cell" 
                                     onclick="showAssignmentModal(${roleHolder.id}, ${dayIndex}, ${timeRange.id})"
                                     style="min-height: 40px; border: 2px dashed var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                                    ${assignment ? `
                                        <div style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                            ${assignment.full_name || '××©×•×‘×¥'}
                                        </div>
                                    ` : `
                                        <span style="color: var(--text-muted); font-size: 24px;">+</span>
                                    `}
                                </div>
                            </td>
                        `;
                    }
                    
                    bodyHTML += '</tr>';
                });
            });
            
            tableBody.innerHTML = bodyHTML;
            tableContainer.style.display = 'block';
        }
        
        // Render notes section
        function renderNotesSection(notes) {
            const notesSection = document.getElementById('scheduleNotesSection');
            const notesTextarea = document.getElementById('scheduleNotes');
            
            if (notesSection && notesTextarea) {
                notesTextarea.value = notes || '';
                notesSection.style.display = 'block';
            }
        }
        
        // Create default time range (08:00-14:00)
        async function createDefaultTimeRange(positionId, weekStart) {
            const israelWeekStart = weekPickerToSundayDate(weekStart);
            const dateString = israelWeekStart.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`${API_BASE}/time-ranges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        positionId: parseInt(positionId),
                        weekStart: dateString,
                        start: '08:00',
                        end: '14:00'
                    })
                });
                
                if (response.ok) {
                    loadScheduleData(); // Reload to show the new time range
                } else {
                    showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×•×— ×©×¢×•×ª ×‘×¨×™×¨×ª ××—×“×œ', 'error');
                }
            } catch (error) {
                console.error('Error creating default time range:', error);
                showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×•×— ×©×¢×•×ª ×‘×¨×™×¨×ª ××—×“×œ', 'error');
            }
        }
        
        // Show time range management modal
        function showTimeRangeModal(editId = null) {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = editId ? '×¢×¨×™×›×ª ×˜×•×•×— ×©×¢×•×ª' : '×”×•×¡×¤×ª ×˜×•×•×— ×©×¢×•×ª';
            modalBody.innerHTML = `
                <form onsubmit="handleTimeRangeSubmit(event, ${editId})">
                    <div class="form-group">
                        <label class="form-label">×©×¢×ª ×”×ª×—×œ×” *</label>
                        <input type="time" class="form-input" name="start" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×©×¢×ª ×¡×™×•× *</label>
                        <input type="time" class="form-input" name="end" required>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                        <button type="submit" class="btn btn-primary">${editId ? '×¢×“×›×Ÿ' : '×”×•×¡×£'} ×˜×•×•×—</button>
                    </div>
                </form>
            `;
            modal.classList.add('active');
        }
        
        // Handle time range form submission
        async function handleTimeRangeSubmit(event, editId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const positionSelect = document.getElementById('schedulePositionSelect');
            const weekPicker = document.getElementById('scheduleWeekPicker');
            
            const timeRangeData = {
                start: formData.get('start'),
                end: formData.get('end')
            };
            
            // Validate start < end
            if (timeRangeData.start >= timeRangeData.end) {
                showToast('×©×¢×ª ×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×', 'error');
                return;
            }
            
            if (!editId) {
                // Add position and week for new time ranges
                const israelWeekStart = weekPickerToSundayDate(weekPicker.value);
                
                timeRangeData.positionId = parseInt(positionSelect.value);
                timeRangeData.weekStart = israelWeekStart.toISOString().split('T')[0];
            }
            
            try {
                const url = editId ? `${API_BASE}/time-ranges/${editId}` : `${API_BASE}/time-ranges`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(timeRangeData)
                });
                
                if (response.ok) {
                    showToast(editId ? '×˜×•×•×— ×©×¢×•×ª ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '×˜×•×•×— ×©×¢×•×ª × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadScheduleData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×©××™×¨×ª ×˜×•×•×— ×”×©×¢×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error saving time range:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Edit time range
        async function editTimeRange(timeRangeId) {
            if (!currentScheduleData) return;
            
            const timeRange = currentScheduleData.timeRanges.find(tr => tr.id === timeRangeId);
            if (!timeRange) return;
            
            showTimeRangeModal(timeRangeId);
            
            // Pre-populate form with current values
            setTimeout(() => {
                const form = document.querySelector('#genericModal form');
                if (form) {
                    form.start.value = timeRange.start.slice(0, 5); // Remove seconds
                    form.end.value = timeRange.end.slice(0, 5);
                }
            }, 100);
        }
        
        // Delete time range
        async function deleteTimeRange(timeRangeId) {
            if (!currentScheduleData || currentScheduleData.timeRanges.length <= 1) {
                showToast('×—×™×™×‘ ×œ×”×™×©××¨ ×œ×¤×—×•×ª ×˜×•×•×— ×©×¢×•×ª ××—×“', 'error');
                return;
            }
            
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×˜×•×•×— ×©×¢×•×ª ×–×”?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/time-ranges/${timeRangeId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('×˜×•×•×— ×©×¢×•×ª × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
                    loadScheduleData();
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘××—×™×§×ª ×˜×•×•×— ×”×©×¢×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error deleting time range:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Show assignment modal
        async function showAssignmentModal(roleId, dayOfWeek, timeBlockId) {
            if (!currentScheduleData) return;
            
            const positionSelect = document.getElementById('schedulePositionSelect');
            const weekPicker = document.getElementById('scheduleWeekPicker');
            
            if (!positionSelect?.value || !weekPicker?.value) return;
            
            console.log('=== MODAL DEBUG ===');
            console.log('Modal opened for slot:', {
                roleId,
                dayOfWeek,
                timeBlockId
            });
            
            // Find the role holder and time range details
            const roleHolder = currentScheduleData.roleHolders.find(rh => rh.id === roleId);
            const timeRange = currentScheduleData.timeRanges.find(tr => tr.id === timeBlockId);
            
            console.log('Modal slot details:', {
                roleHolder: roleHolder ? roleHolder.name : 'NOT FOUND',
                timeRange: timeRange ? `${timeRange.start}-${timeRange.end}` : 'NOT FOUND'
            });
            
            if (!roleHolder || !timeRange) {
                showToast('×©×’×™××”: ×œ× × ××¦××• × ×ª×•× ×™ ×ª×¤×§×™×“×Ÿ ××• ×˜×•×•×— ×©×¢×•×ª', 'error');
                return;
            }
            
            // Calculate the specific date
            const israelWeekStart = weekPickerToSundayDate(weekPicker.value);
            const targetDate = new Date(israelWeekStart.getTime() + dayOfWeek * 24 * 60 * 60 * 1000);
            const dateString = targetDate.toISOString().split('T')[0];
            
            // Check if there's already an assignment
            const existingAssignment = currentScheduleData.assignments.find(a => 
                a.role_id === roleId && 
                a.day_of_week === dayOfWeek && 
                a.time_block_id === timeBlockId
            );
            
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const daysHeb = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            
            modalTitle.textContent = existingAssignment ? '×¢×¨×™×›×ª ×©×™×‘×•×¥' : '×©×™×‘×•×¥ ××“× ×œ×ª×¤×§×™×“';
            
            // Get skill names for required qualifications
            let requiredSkillsText = '';
            if (roleHolder.required_skill_ids && roleHolder.required_skill_ids.length > 0) {
                try {
                    const skillsResponse = await fetch(`${API_BASE}/skills`);
                    if (skillsResponse.ok) {
                        const allSkills = await skillsResponse.json();
                        const requiredSkills = allSkills.filter(skill => 
                            roleHolder.required_skill_ids.includes(skill.id)
                        );
                        const skillNames = requiredSkills.map(skill => skill.name);
                        requiredSkillsText = `<p style="margin: 4px 0;"><strong>×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª:</strong> ${skillNames.join(', ')}</p>`;
                    } else {
                        requiredSkillsText = `<p style="margin: 4px 0;"><strong>×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª:</strong> ID ${roleHolder.required_skill_ids.join(', ')}</p>`;
                    }
                } catch (error) {
                    console.error('Error loading skills for assignment modal:', error);
                    requiredSkillsText = `<p style="margin: 4px 0;"><strong>×›×©×™×¨×•×™×•×ª × ×“×¨×©×•×ª:</strong> ID ${roleHolder.required_skill_ids.join(', ')}</p>`;
                }
            }
            
            modalBody.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">×¤×¨×˜×™ ×”×©×™×‘×•×¥:</h4>
                    <p style="margin: 4px 0;"><strong>×ª×¤×§×™×“×Ÿ:</strong> ${roleHolder.name}</p>
                    <p style="margin: 4px 0;"><strong>×™×•×:</strong> ${daysHeb[dayOfWeek]}</p>
                    <p style="margin: 4px 0;"><strong>×©×¢×•×ª:</strong> ${timeRange.start.slice(0,5)} - ${timeRange.end.slice(0,5)}</p>
                    <p style="margin: 4px 0;"><strong>×ª××¨×™×š:</strong> ${targetDate.toLocaleDateString('he-IL')}</p>
                    ${requiredSkillsText}
                </div>
                
                <div class="form-group">
                    <label class="form-label">×‘×—×¨ ××“× ×œ×©×™×‘×•×¥:</label>
                    <div id="personnelOptions" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">×˜×•×¢×Ÿ ×¨×©×™××ª ×× ×©×™×...</div>
                    </div>
                </div>
                
                ${existingAssignment ? `
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="removeAssignment(${roleId}, ${dayOfWeek}, ${timeBlockId})" style="width: 100%;">
                            ×”×¡×¨ ×©×™×‘×•×¥ × ×•×›×—×™
                        </button>
                    </div>
                ` : ''}
                
                <div class="form-group" style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Load qualified personnel
            await loadQualifiedPersonnel(roleHolder, dateString, timeRange, roleId, dayOfWeek, timeBlockId, existingAssignment);
        }
        
        // Load personnel who meet qualifications and have no conflicts
        async function loadQualifiedPersonnel(roleHolder, dateString, timeRange, roleId, dayOfWeek, timeBlockId, existingAssignment) {
            const container = document.getElementById('personnelOptions');
            if (!container) return;
            
            try {
                // Get all personnel with their qualifications and constraints
                const personnelResponse = await fetch(`${API_BASE}/personnel`);
                if (!personnelResponse.ok) {
                    throw new Error('Failed to load personnel');
                }
                const allPersonnel = await personnelResponse.json();
                
                // Filter personnel who meet ALL required qualifications
                const qualifiedPersonnel = [];
                const unqualifiedPersonnel = [];
                const conflictedPersonnel = [];
                
                for (const person of allPersonnel) {
                    // Check qualifications
                    let hasAllQualifications = true;
                    const missingSkills = [];
                    
                    if (roleHolder.required_skill_ids && roleHolder.required_skill_ids.length > 0) {
                        // Get person's skills
                        const skillsResponse = await fetch(`${API_BASE}/personnel/${person.id}/skills`);
                        let personSkills = [];
                        if (skillsResponse.ok) {
                            personSkills = await skillsResponse.json();
                        }
                        
                        const personSkillIds = personSkills
                            .filter(ps => ps.status === '××•×¡××š ×›×©×™×¨')
                            .map(ps => ps.skill_id);
                        
                        for (const requiredSkillId of roleHolder.required_skill_ids) {
                            if (!personSkillIds.includes(requiredSkillId)) {
                                hasAllQualifications = false;
                                missingSkills.push(requiredSkillId);
                            }
                        }
                    }
                    
                    // Check constraints for the specific date and time
                    let hasConflict = false;
                    let conflictReason = '';
                    
                    const constraintsResponse = await fetch(`${API_BASE}/constraints?person_id=${person.id}&date=${dateString}`);
                    if (constraintsResponse.ok) {
                        const allConstraints = await constraintsResponse.json();
                        
                        // Filter constraints to ONLY the exact date we're checking
                        const constraints = allConstraints.filter(constraint => constraint.date === dateString);
                        
                        for (const constraint of constraints) {
                            if (constraint.is_full_day) {
                                hasConflict = true;
                                conflictReason = `${constraint.type} - ×™×•× ××œ×`;
                                break;
                            } else if (constraint.start_time && constraint.end_time) {
                                // Check if time ranges overlap
                                const constraintStart = constraint.start_time;
                                const constraintEnd = constraint.end_time;
                                const assignmentStart = timeRange.start;
                                const assignmentEnd = timeRange.end;
                                
                                if ((assignmentStart < constraintEnd && assignmentEnd > constraintStart)) {
                                    hasConflict = true;
                                    conflictReason = `${constraint.type} ${constraintStart.slice(0,5)}-${constraintEnd.slice(0,5)}`;
                                    break;
                                }
                            }
                        }
                    }
                    
                    const personData = {
                        ...person,
                        hasAllQualifications,
                        missingSkills,
                        hasConflict,
                        conflictReason
                    };
                    
                    
                    if (!hasAllQualifications) {
                        unqualifiedPersonnel.push(personData);
                    } else if (hasConflict) {
                        // Qualified but has constraints - show as qualified with warning
                        qualifiedPersonnel.push(personData);
                    } else {
                        qualifiedPersonnel.push(personData);
                    }
                }
                
                // Render personnel options
                let html = '';
                
                if (qualifiedPersonnel.length > 0) {
                    html += '<h4 style="color: var(--success); margin: 0 0 8px 0;">âœ… ×›×©×™×¨×™× ×œ×©×™×‘×•×¥:</h4>';
                    qualifiedPersonnel.forEach(person => {
                        const isCurrentlyAssigned = existingAssignment && existingAssignment.person_id === person.id;
                        const hasConstraintWarning = person.hasConflict;
                        const borderColor = hasConstraintWarning ? 'var(--warning)' : 'var(--success)';
                        const iconColor = hasConstraintWarning ? 'var(--warning)' : 'var(--success)';
                        const icon = hasConstraintWarning ? 'âš ï¸' : 'âœ…';
                        
                        html += `
                            <div class="personnel-option qualified" onclick="assignPerson(${person.id}, '${person.full_name}', ${roleId}, ${dayOfWeek}, ${timeBlockId})" 
                                 style="padding: 12px; margin: 8px 0; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; background: ${isCurrentlyAssigned ? 'var(--success-bg)' : 'var(--bg-primary)'}; transition: all 0.2s ease;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${person.full_name}</strong> - ${person.rank}
                                        <br><small>${person.branch} | ${person.personal_number}</small>
                                        ${isCurrentlyAssigned ? '<br><span style="color: var(--success); font-weight: bold;">ğŸ¯ ××©×•×‘×¥ ×›×¢×ª</span>' : ''}
                                        ${hasConstraintWarning ? `<br><span style="color: var(--warning); font-weight: bold;">âš ï¸ ××™×œ×•×¥: ${person.conflictReason}</span>` : ''}
                                    </div>
                                    <span style="color: ${iconColor}; font-size: 24px;">${icon}</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Removed unqualified personnel section - only show fully qualified candidates
                
                if (qualifiedPersonnel.length === 0) {
                    html = '<div style="text-align: center; padding: 20px; color: var(--danger);">âŒ ××™×Ÿ ×× ×©×™× ×›×©×™×¨×™× ×œ×©×™×‘×•×¥ ×–×”</div>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading qualified personnel:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×× ×©×™ ×”×¦×•×•×ª</div>';
            }
        }
        
        // Assign person to role/time slot
        async function assignPerson(personId, personName, roleId, dayOfWeek, timeBlockId) {
            const positionSelect = document.getElementById('schedulePositionSelect');
            const weekPicker = document.getElementById('scheduleWeekPicker');
            
            if (!positionSelect?.value || !weekPicker?.value) return;
            
            // Calculate date
            const israelWeekStart = weekPickerToSundayDate(weekPicker.value);
            const targetDate = new Date(israelWeekStart.getTime() + dayOfWeek * 24 * 60 * 60 * 1000);
            const dateString = targetDate.toISOString().split('T')[0];
            
            const timeRange = currentScheduleData.timeRanges.find(tr => tr.id === timeBlockId);
            
            const assignmentData = {
                positionId: parseInt(positionSelect.value),
                weekStart: israelWeekStart.toISOString().split('T')[0],
                roleHolderId: roleId,
                dayOfWeek: dayOfWeek, // Explicitly send dayOfWeek to avoid server recalculation
                date: dateString,
                start: timeRange.start,
                end: timeRange.end,
                personnelId: personId
            };
            
            try {
                const response = await fetch(`${API_BASE}/assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assignmentData)
                });
                
                if (response.ok) {
                    showToast(`${personName} ×©×•×‘×¥ ×‘×”×¦×œ×—×”!`, 'success');
                    closeModal();
                    loadScheduleData(); // Refresh the schedule
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×©×™×‘×•×¥ ×”××“×', 'error');
                }
            } catch (error) {
                console.error('Error assigning person:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Remove assignment
        async function removeAssignment(roleId, dayOfWeek, timeBlockId) {
            if (!currentScheduleData) return;
            
            const assignment = currentScheduleData.assignments.find(a => 
                a.role_id === roleId && 
                a.day_of_week === dayOfWeek && 
                a.time_block_id === timeBlockId
            );
            
            if (!assignment) {
                showToast('×œ× × ××¦× ×©×™×‘×•×¥ ×œ×”×¡×¨×”', 'error');
                return;
            }
            
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ×©×™×‘×•×¥ ×–×”?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/assignments/${assignment.id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('×©×™×‘×•×¥ ×”×•×¡×¨ ×‘×”×¦×œ×—×”!', 'success');
                    closeModal();
                    loadScheduleData(); // Refresh the schedule
                } else {
                    const error = await response.json();
                    showToast(error.error || '×©×’×™××” ×‘×”×¡×¨×ª ×”×©×™×‘×•×¥', 'error');
                }
            } catch (error) {
                console.error('Error removing assignment:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Update schedule notes
        async function updateScheduleNotes() {
            const positionSelect = document.getElementById('schedulePositionSelect');
            const weekPicker = document.getElementById('scheduleWeekPicker');
            const notesTextarea = document.getElementById('scheduleNotes');
            
            if (!positionSelect?.value || !weekPicker?.value || !notesTextarea) return;
            
            const israelWeekStart = weekPickerToSundayDate(weekPicker.value);
            
            try {
                const response = await fetch(`${API_BASE}/schedule/notes?positionId=${positionSelect.value}&weekStart=${israelWeekStart.toISOString().split('T')[0]}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes: notesTextarea.value })
                });
                
                if (response.ok) {
                    showToast('×”×¢×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!', 'success');
                } else {
                    showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×”×¢×¨×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }
        
        // Show schedule states
        function showScheduleState(state) {
            const tableContainer = document.getElementById('scheduleTableContainer');
            const timeRangesHeader = document.getElementById('timeRangesHeader');
            const notesSection = document.getElementById('scheduleNotesSection');
            const emptyState = document.getElementById('scheduleEmptyState');
            const loadingState = document.getElementById('scheduleLoadingState');
            const errorState = document.getElementById('scheduleErrorState');
            
            // Hide all states first
            [tableContainer, timeRangesHeader, notesSection, emptyState, loadingState, errorState].forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            // Show requested state
            switch(state) {
                case 'table':
                    if (tableContainer) tableContainer.style.display = 'block';
                    if (timeRangesHeader) timeRangesHeader.style.display = 'block';
                    if (notesSection) notesSection.style.display = 'block';
                    break;
                case 'empty':
                    if (emptyState) emptyState.style.display = 'block';
                    break;
                case 'loading':
                    if (loadingState) loadingState.style.display = 'block';
                    break;
                case 'error':
                    if (errorState) errorState.style.display = 'block';
                    break;
            }
        }
    </script>
</body>
</html>